<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Korean Trainer PRO+ (Premium Edition)</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/css/index.css">
<script src="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/index.js"></script>
<script src="https://unpkg.com/hangul-js" type="text/javascript"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
    /* B·∫¢NG M√ÄU CHUY√äN NGHI·ªÜP, SANG TR·ªåNG (PREMIUM UI) */
    :root {
        --bg: #F3F4F6; /* X√°m nh·∫°t cao c·∫•p */
        --card: #FFFFFF; 
        --border: #E5E7EB;
        --border-hover: #D1D5DB;
        --primary: #4F46E5; /* Xanh Indigo sang tr·ªçng */
        --primary-hover: #4338CA;
        --primary-light: #EEF2FF;
        --success: #10B981; /* Xanh l√° d·ªãu */
        --success-light: #ECFDF5;
        --danger: #EF4444; /* ƒê·ªè d·ªãu */
        --danger-light: #FEF2F2;
        --text: #111827; /* ƒêen tuy·ªÅn */
        --text-muted: #6B7280; /* X√°m trung t√≠nh */
    }
    
    body { font-family: 'Plus Jakarta Sans', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 50px; line-height: 1.6; -webkit-font-smoothing: antialiased;}
    
    header { background: #FFFFFF; color: var(--text); padding: 18px 20px; font-size: 20px; text-align: center; font-weight: 800; border-bottom: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.03); letter-spacing: -0.5px;}
    header i { color: var(--primary); margin-right: 8px;}
    main { max-width: 1000px; margin: 35px auto; padding: 0 20px; }
    
    /* GIAO DI·ªÜN TH·∫∫ (CARD) C√ì CHI·ªÄU S√ÇU */
    .card { background: var(--card); border-radius: 16px; padding: 35px; margin-bottom: 25px; border: 1px solid #F3F4F6; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03); }
    .header-card { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;}
    
    /* N√öT B·∫§M CAO C·∫§P */
    button { background: var(--primary); border: 1px solid transparent; padding: 12px 24px; border-radius: 12px; color: white; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); display: inline-flex; align-items: center; gap: 8px; justify-content: center;}
    button:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25);}
    button:active { transform: translateY(0); box-shadow: none; }
    
    button.basic-btn { background: #FFFFFF; color: var(--text); border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.02);}
    button.basic-btn:hover { background: #F9FAFB; border-color: var(--border-hover); color: var(--text); box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
    
    .btn-icon { padding: 14px; border-radius: 12px; font-size: 18px; }
    
    /* MENU CH√çNH S·∫ÆC N√âT */
    .grid-center-container { display: flex; justify-content: center; width: 100%; margin-top: 30px;}
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; width: 100%;}
    .big-btn { font-size: 16px; padding: 25px 20px; border-radius: 16px; justify-content: center; flex-direction: column; gap: 12px; background: #FFFFFF; border: 1px solid var(--border); text-align: center; color: var(--text); font-weight: 700; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.02);}
    .big-btn i { font-size: 32px; margin-bottom: 5px; color: var(--primary); opacity: 0.9; transition: transform 0.2s;}
    .big-btn:hover { border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.1); background: var(--primary-light); color: var(--primary);}
    .big-btn:hover i { transform: scale(1.1); opacity: 1;}
    
    /* THANH KINH NGHI·ªÜM T·∫æ NH·ªä */
    .progress-wrap { background: #E5E7EB; height: 8px; border-radius: 10px; overflow: hidden; margin-top: 15px;}
    .bar { background: linear-gradient(90deg, #10B981, #34D399); height: 100%; width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 10px;}
    
    /* FLASHCARD HI·ªÜN ƒê·∫†I */
    .flash-container { text-align: center; min-height: 280px; display: flex; flex-direction: column; justify-content: center; background: #FFFFFF; border-radius: 20px; padding: 40px; margin: 20px 0; position: relative; border: 1px solid var(--border); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);}
    .flash-counter { position: absolute; top: 20px; left: 20px; font-size: 14px; color: var(--text-muted); font-weight: 600; background: #F3F4F6; padding: 6px 14px; border-radius: 12px;}
    .flash-word { font-size: 56px; font-weight: 800; margin-bottom: 10px; color: var(--text); letter-spacing: -1px;}
    .flash-pr { font-size: 20px; color: var(--text-muted); font-style: italic; margin-bottom: 25px; }
    .flash-vi { font-size: 28px; color: var(--primary); font-weight: 700; }
    
    /* TR·∫ÆC NGHI·ªÜM & GH√âP C·∫∂P C√ì ƒê·ªò T∆Ø∆†NG PH·∫¢N CAO */
    .quiz-title { font-size: 32px; text-align: center; margin: 30px 0 40px 0; font-weight: 800; color: var(--text); letter-spacing: -0.5px;}
    .quiz-title .pr-text { display: block; font-size: 18px; color: var(--text-muted); font-weight: 500; margin-top: 8px; font-style: italic; }
    .quiz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; max-width: 800px; margin: 0 auto;}
    
    /* C·∫£i thi·ªán N√∫t Game: N·ªÅn x√°m nh·∫°t, vi·ªÅn r√µ n√©t ƒë·ªÉ kh√¥ng b·ªã ch√¨m v√†o n·ªÅn tr·∫Øng */
    .quiz-option { background: #F9FAFB; padding: 25px 20px; border-radius: 16px; cursor: pointer; text-align: center; font-size: 18px; font-weight: 700; border: 2px solid var(--border); transition: all 0.2s; color: var(--text); display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 90px;}
    .quiz-option:hover { border-color: var(--primary); background: var(--primary-light); color: var(--primary); box-shadow: 0 4px 6px rgba(79, 70, 229, 0.1);}
    
    .match-container { display: flex; justify-content: center; align-items: center; padding: 20px 0; }
    .match-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; max-width: 900px; }
    .match-box { background: #F9FAFB; padding: 20px 15px; border-radius: 16px; text-align: center; cursor: pointer; font-size: 18px; font-weight: 700; border: 2px solid var(--border); transition: all 0.2s; color: var(--text); display: flex; align-items: center; justify-content: center; min-height: 80px;}
    .match-box:hover { border-color: var(--primary); background: var(--primary-light); color: var(--primary);}
    .match-box.selected { background: var(--primary); border-color: var(--primary); color: white; transform: scale(1.02); box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);}
    .match-box.hidden { visibility: hidden; opacity: 0; pointer-events: none;}
    
    /* √î NH·∫¨P LI·ªÜU CHUY√äN NGHI·ªÜP */
    .ai-write-container { padding: 10px; width: 100%; box-sizing: border-box;}
    .ai-target-word { font-size: 40px; color: var(--primary); font-weight: 800; margin: 15px 0 5px 0; text-align: center; letter-spacing: -1px;}
    .ai-target-vi { font-size: 18px; color: var(--text-muted); font-weight: 600; margin-bottom: 30px; text-align: center;}
    .ai-custom-input, .ai-textarea { width: 100%; padding: 18px; font-size: 16px; border-radius: 12px; border: 1px solid var(--border-hover); background: #FFFFFF; outline: none; box-sizing: border-box; margin-bottom: 20px; font-family: inherit; font-weight: 500; transition: all 0.2s; color: var(--text); box-shadow: 0 1px 2px rgba(0,0,0,0.02);}
    .ai-custom-input:focus, .ai-textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15); }
    .ai-textarea { height: 140px; resize: vertical; }
    
    /* B·∫¢NG AI ƒê√ÅNH GI√Å (S·∫°ch s·∫Ω, m√†u s·∫Øc ki·ªÉm so√°t) */
    .ai-result-box { margin-top: 30px; padding: 25px 30px; background: #FFFFFF; border-radius: 16px; text-align: left; font-size: 16px; line-height: 1.7; display: none; border: 1px solid var(--border); border-left: 4px solid var(--primary); color: var(--text); box-shadow: 0 4px 15px rgba(0,0,0,0.03);}
    .ai-result-box strong, .ai-result-box b { color: #111827; font-weight: 700;}
    
    .loader { border: 3px solid #E5E7EB; border-top: 3px solid white; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px;}
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* B√ÄN PH√çM ·∫¢O & TOAST */
    #keyboard-wrap { position: fixed; bottom: 0; left: 0; width: 100%; background: #F3F4F6; padding: 20px 10px; box-sizing: border-box; z-index: 1000; display: none; border-top: 1px solid var(--border); box-shadow: 0 -10px 25px rgba(0,0,0,0.05);}
    #keyboard-wrap.show { display: block; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .keyboard-close-btn { position: absolute; top: -45px; right: 20px; background: #FFFFFF; color: var(--text); border: 1px solid var(--border); padding: 8px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .hg-theme-default { font-family: inherit; background-color: transparent !important; color: var(--text); max-width: 900px; margin: 0 auto; }
    .hg-theme-default .hg-button { background: #FFFFFF !important; color: var(--text) !important; border: 1px solid var(--border) !important; border-bottom: 2px solid var(--border-hover) !important; border-radius: 10px !important; font-size: 18px; height: 50px !important; font-weight: 600; box-shadow: 0 1px 2px rgba(0,0,0,0.02);}
    .hg-theme-default .hg-button:active { transform: translateY(1px); background: #F9FAFB !important; border-bottom-width: 1px !important;}
    
    .hide { display: none !important; }
    #toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(100px); background: #111827; color: white; padding: 16px 30px; border-radius: 12px; font-size: 15px; font-weight: 600; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); z-index: 3000; opacity: 0; display: flex; align-items: center; gap: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);}
    #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(17, 24, 39, 0.7); z-index: 2000; overflow-y: auto; padding: 20px; box-sizing: border-box; backdrop-filter: blur(4px); }
    .edit-word-row { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: center;}
</style>
</head>

<body>
<header>Ti·∫øng H√†n PRO+</header>

<div id="editModal" class="modal-overlay hide">
    <div class="card" style="max-width: 900px; margin: 40px auto;">
        <h3 id="modalTitle" style="margin-top: 0; font-size: 22px; color: var(--text); font-weight: 800;"><i class="fa-solid fa-pen-to-square" style="color:var(--text-muted); margin-right:8px;"></i> Qu·∫£n L√Ω Th∆∞ M·ª•c</h3>
        <p style="color: var(--text-muted); font-size: 14px; font-weight: 600; margin-bottom: 8px;">T√™n b√†i h·ªçc:</p>
        <input type="text" id="editSetName" class="ai-custom-input" placeholder="V√≠ d·ª•: B√†i 1..." style="padding: 15px;">
        <p style="color: var(--text-muted); font-size: 14px; font-weight: 600; margin-bottom: 8px;">Danh s√°ch t·ª´ v·ª±ng:</p>
        <div id="editSetWords" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px; padding: 15px; border: 1px solid var(--border); border-radius: 12px; background: #F9FAFB;"></div>
        <button type="button" onclick="addNewEditRow()" class="basic-btn" style="width: 100%; margin-bottom: 25px;"><i class="fa-solid fa-plus"></i> Th√™m T·ª´ M·ªõi</button>
        <div style="display: flex; gap: 15px; justify-content: flex-end;">
            <button onclick="closeEditModal()" class="basic-btn"><i class="fa-solid fa-xmark"></i> H·ªßy</button>
            <button onclick="saveEditSet()"><i class="fa-solid fa-floppy-disk"></i> L∆∞u L·∫°i</button>
        </div>
    </div>
</div>

<div id="keyboard-wrap">
    <button class="keyboard-close-btn" onclick="closeKeyboard()"><i class="fa-solid fa-chevron-down"></i> ƒê√≥ng</button>
    <div class="simple-keyboard"></div>
</div>

<main>
    <div id="toast">Th√¥ng b√°o</div>

    <div id="home">
        <div class="card">
            <div class="header-card">
                <div>
                    <h2 style="margin: 0; color: var(--text); font-size: 24px; font-weight: 800; letter-spacing: -0.5px;">C·∫•p ƒë·ªô: <span id="level">1</span></h2>
                    <p style="margin: 6px 0 0 0; color: var(--text-muted); font-weight: 600; font-size: 14px;">Ti·∫øn tr√¨nh: <span id="exp">0</span> / 100</p>
                </div>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <input type="file" id="file" class="hide" accept=".xlsx, .xls" onchange="loadExcel()">
                    <button onclick="document.getElementById('file').click()" class="basic-btn"><i class="fa-solid fa-file-arrow-up" style="color: var(--primary);"></i> Nh·∫≠p Excel</button>
                    <button onclick="openCreateModal()" class="basic-btn"><i class="fa-solid fa-folder-plus" style="color: var(--primary);"></i> T·∫°o B√†i M·ªõi</button>
                </div>
            </div>
            <div class="progress-wrap"><div class="bar" id="bar"></div></div>
        </div>

        <div class="card" id="libraryCard" class="hide">
            <div style="font-size: 18px; margin-bottom: 20px; font-weight: 700; color: var(--text); border-bottom: 1px solid var(--border); padding-bottom: 15px;">Th∆∞ vi·ªán h·ªçc t·∫≠p (<span id="setCountText">0</span>) </div>
            <div id="vocabSetsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;"></div>
        </div>

        <div class="grid-center-container">
            <div class="grid">
                <button class="big-btn" onclick="openScreen('flash')"><i class="fa-solid fa-layer-group"></i> Th·∫ª Ghi Nh·ªõ</button>
                <button class="big-btn" onclick="openScreen('listen')"><i class="fa-solid fa-headphones"></i> Luy·ªán Nghe</button>
                <button class="big-btn" onclick="openScreen('quiz_kr_vi')"><i class="fa-solid fa-spell-check"></i> Tr·∫Øc Nghi·ªám H√†n ‚ûî Vi·ªát</button>
                <button class="big-btn" onclick="openScreen('quiz_vi_kr')"><i class="fa-solid fa-language"></i> Tr·∫Øc Nghi·ªám Vi·ªát ‚ûî H√†n</button>
                <button class="big-btn" onclick="openScreen('match')"><i class="fa-solid fa-puzzle-piece"></i> Gh√©p C·∫∑p T·ª´</button>
                <button class="big-btn" onclick="openScreen('auto_write')"><i class="fa-solid fa-pen-nib"></i> Luy·ªán ƒê·∫∑t C√¢u</button>
                <button class="big-btn" onclick="openScreen('auto_translate')" style="grid-column: 1 / -1;"><i class="fa-solid fa-comments"></i> D·ªãch T·ª± Do & S·ª≠a Ng·ªØ Ph√°p</button>
            </div>
        </div>
    </div>

    <div id="listen" class="hide">
        <div class="card">
            <button onclick="back()" class="basic-btn" style="margin-bottom: 20px;"><i class="fa-solid fa-arrow-left"></i> Quay l·∫°i</button>
            <div class="ai-write-container" style="max-width: 700px; margin: 0 auto;">
                <h2 style="color: var(--text); font-weight: 800; font-size: 28px; text-align: center;">Luy·ªán Nghe</h2>
                <div style="text-align: center; color: var(--text-muted); font-size: 14px; font-weight: 600; margin-bottom: 30px;">C√¢u: <span id="listenCounterText">1/1</span></div>
                
                <div style="text-align: center; margin: 40px 0;"><button class="btn-icon" style="background: var(--primary-light); color: var(--primary); border: none; font-size: 28px; padding: 25px; border-radius: 50%; transition: all 0.2s;" onclick="playListenAudio()"><i class="fa-solid fa-volume-high"></i></button></div>
                
                <input type="text" id="listenInput" class="ai-custom-input" placeholder="Nh·∫≠p ti·∫øng H√†n b·∫°n nghe ƒë∆∞·ª£c..." autocomplete="off" style="text-align: center;">
                <div style="text-align: right; margin-bottom: 25px;"><button type="button" onclick="showKeyboard('listenInput')" class="basic-btn" style="padding: 8px 15px; font-size: 13px;"><i class="fa-solid fa-keyboard"></i> B√†n ph√≠m ·∫£o</button></div>
                
                <div style="display: flex; justify-content: center; gap: 15px;">
                    <button onclick="skipListenGame()" class="basic-btn"><i class="fa-solid fa-forward-step"></i> B·ªè qua</button>
                    <button onclick="checkListen()" style="background: var(--primary);"><i class="fa-solid fa-check"></i> Ki·ªÉm Tra</button>
                </div>
                <div id="listenResult" style="margin-top: 35px; font-size: 18px; font-weight: 600; text-align: center; min-height: 30px;"></div>
            </div>
        </div>
    </div>

    <div id="auto_write" class="hide">
        <div class="card">
            <button onclick="back()" class="basic-btn"><i class="fa-solid fa-arrow-left"></i> Quay l·∫°i</button>
            <div class="ai-write-container">
                <p style="color: var(--text-muted); font-size: 16px; font-weight: 600; text-align: center; margin-top: 30px;">H√£y ƒë·∫∑t m·ªôt c√¢u ti·∫øng H√†n s·ª≠ d·ª•ng t·ª´:</p>
                <div class="ai-target-word" id="autoWordKr">---</div>
                <div class="ai-target-vi" id="autoWordVi">---</div>
                
                <textarea id="autoInput" class="ai-textarea" placeholder="Nh·∫≠p c√¢u ti·∫øng H√†n c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea>
                <div style="text-align: right; margin-bottom: 25px;"><button type="button" onclick="showKeyboard('autoInput')" class="basic-btn" style="padding: 8px 15px; font-size: 13px;"><i class="fa-solid fa-keyboard"></i> B√†n ph√≠m ·∫£o</button></div>
                
                <div style="display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
                    <button onclick="generateNewAutoPrompt()" class="basic-btn"><i class="fa-solid fa-rotate-right"></i> ƒê·ªïi t·ª´ kh√°c</button>
                    <button onclick="checkSentenceBasic()" class="basic-btn" id="basicCheckBtn"><i class="fa-solid fa-bolt"></i> D·ªãch Nhanh</button>
                    <button onclick="checkSentenceAI()" style="background: var(--primary);" id="aiCheckBtn"><i class="fa-solid fa-wand-magic-sparkles"></i> AI Ph√¢n T√≠ch</button>
                </div>
                <div id="autoResult" class="ai-result-box"></div>
            </div>
        </div>
    </div>

    <div id="auto_translate" class="hide">
        <div class="card">
            <button onclick="back()" class="basic-btn"><i class="fa-solid fa-arrow-left"></i> Quay l·∫°i</button>
            <div class="ai-write-container">
                <h2 style="text-align: center; color: var(--text); margin-bottom: 40px; font-weight: 800; font-size: 28px; letter-spacing: -0.5px;">D·ªãch T·ª± Do & S·ª≠a Ng·ªØ Ph√°p</h2>
                
                <p style="color: var(--text); font-size: 15px; font-weight: 700; margin-bottom: 10px;">1. C√¢u Ti·∫øng Vi·ªát b·∫°n mu·ªën n√≥i:</p>
                <input type="text" id="autoTransVi" class="ai-custom-input" placeholder="V√≠ d·ª•: Cu·ªëi tu·∫ßn n√†y t√¥i ƒë·ªãnh ƒëi xem phim c√πng b·∫°n...">
                
                <p style="color: var(--text); font-size: 15px; font-weight: 700; margin-bottom: 10px; margin-top: 25px;">2. D·ªãch sang Ti·∫øng H√†n theo c√°ch c·ªßa b·∫°n:</p>
                <textarea id="autoTransKr" class="ai-textarea" placeholder="T·ª± vi·∫øt b·∫±ng ti·∫øng H√†n..."></textarea>
                
                <div style="text-align: right; margin-bottom: 30px;"><button type="button" onclick="showKeyboard('autoTransKr')" class="basic-btn" style="padding: 8px 15px; font-size: 13px;"><i class="fa-solid fa-keyboard"></i> B√†n ph√≠m ·∫£o</button></div>
                
                <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <button onclick="resetAutoTranslation()" class="basic-btn" style="color: var(--danger);"><i class="fa-solid fa-trash-can"></i> X√≥a l√†m l·∫°i</button>
                    <button onclick="checkTranslationBasic()" class="basic-btn" id="basicTransBtn"><i class="fa-solid fa-bolt"></i> D·ªãch Google</button>
                    <button onclick="checkTranslationAI()" style="background: var(--primary);" id="aiTransBtn"><i class="fa-solid fa-wand-magic-sparkles"></i> AI Ph√¢n T√≠ch</button>
                </div>
                <div id="autoTransResult" class="ai-result-box"></div>
            </div>
        </div>
    </div>

    <div id="flash" class="hide">
        <div class="card">
            <button onclick="back()" class="basic-btn"><i class="fa-solid fa-arrow-left"></i> Quay l·∫°i</button>
            <div class="flash-container" style="max-width: 800px; margin: 30px auto;">
                <div class="flash-counter" id="flashCounter">1/1</div>
                <div class="flash-word" id="flashWord">---</div>
                <div class="flash-pr" id="flashPr"></div>
                <div class="flash-vi" id="flashMean">---</div>
            </div>
            <div class="flash-controls">
                <button class="basic-btn btn-icon" style="padding: 15px 25px;" onclick="prev()"><i class="fa-solid fa-chevron-left"></i></button>
                <button class="btn-icon" style="background: var(--primary-light); color: var(--primary); border: none; padding: 15px 30px; font-size: 20px;" onclick="speak()"><i class="fa-solid fa-volume-high"></i></button>
                <button class="basic-btn btn-icon" style="padding: 15px 25px;" onclick="next()"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            <p style="text-align: center; color: var(--text-muted); font-size: 14px; font-weight: 500; margin-top: 25px;">L∆∞·ªõt th·∫ª ƒë·ªÉ √¥n t·∫≠p (kh√¥ng c·ªông ƒëi·ªÉm kinh nghi·ªám).</p>
        </div>
    </div>
    
    <div id="quiz" class="hide">
        <div class="card">
            <button onclick="back()" class="basic-btn"><i class="fa-solid fa-arrow-left"></i> Quay l·∫°i</button>
            <div style="text-align:center; font-size:15px; color:var(--text-muted); margin-top:20px; font-weight:600;"><i class="fa-regular fa-clock"></i> Th·ªùi gian: <span id="quizTimer">0</span>s</div>
            <div id="quizBox"></div>
        </div>
    </div>
    
    <div id="match" class="hide">
        <div class="card">
            <button onclick="back()" class="basic-btn"><i class="fa-solid fa-arrow-left"></i> Quay l·∫°i</button>
            <div class="match-container">
                <div class="match-grid" id="matchBox"></div>
            </div>
        </div>
    </div>
</main>

<script>
// --- √ÇM THANH "BLOOP" (GI·ªåT N∆Ø·ªöC) C·ª∞C K·ª≤ √äM √ÅI ---
function playSuccessSound() {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        // T·∫°o √¢m thanh gi·ªçt n∆∞·ªõc (t·∫ßn s·ªë th·∫•p, tƒÉng nh·∫π r·ªìi t·∫Øt ngay l·∫≠p t·ª©c)
        osc.type = 'sine'; 
        osc.frequency.setValueAtTime(400, ctx.currentTime); 
        osc.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.1); 
        
        // √Çm l∆∞·ª£ng si√™u nh·ªè, t·∫Øt c·ª±c nhanh g·ªçn
        gain.gain.setValueAtTime(0.1, ctx.currentTime); 
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15); 
        
        osc.start();
        osc.stop(ctx.currentTime + 0.15);
    } catch(e) {}
}

let vocabSets = []; let activeSetIds = []; let vocab = []; 
let index = 0, exp = 0, level = 1, selected = null; let currentAIWord = null; let editingSetId = null; let listenIndex = 0; 
let quizStartTime; let quizTimerInterval; let currentQuizType = 'quiz_kr_vi';

let keyboard; let activeVirtualInput = null; let isKeyboardShift = false;
document.addEventListener("DOMContentLoaded", () => {
    if(window.SimpleKeyboard) {
        keyboard = new window.SimpleKeyboard.default({
            theme: "hg-theme-default",
            layout: { 'default': ["„ÖÇ „Öà „Ñ∑ „Ñ± „ÖÖ „Öõ „Öï „Öë „Öê „Öî {bksp}", "„ÖÅ „Ñ¥ „Öá „Ñπ „Öé „Öó „Öì „Öè „Ö£ {enter}", "{shift} „Öã „Öå „Öä „Öç „Ö† „Öú „Ö° {shift}", "{space}"], 'shift': ["„ÖÉ „Öâ „Ñ∏ „Ñ≤ „ÖÜ „Öõ „Öï „Öë „Öí „Öñ {bksp}", "„ÖÅ „Ñ¥ „Öá „Ñπ „Öé „Öó „Öì „Öè „Ö£ {enter}", "{shift} „Öã „Öå „Öä „Öç „Ö† „Öú „Ö° {shift}", "{space}"] },
            display: { "{bksp}": "‚å´ X√≥a", "{enter}": "‚Üµ", "{shift}": "‚áß", "{space}": "D·∫•u c√°ch" },
            onKeyPress: button => handleVirtualKeyPress(button)
        });
    }
});
function handleVirtualKeyPress(button) {
    if (!activeVirtualInput) return;
    if (button === "{shift}") { isKeyboardShift = !isKeyboardShift; keyboard.setOptions({ layoutName: isKeyboardShift ? "shift" : "default" }); return; }
    let text = activeVirtualInput.value; let jamoArray = Hangul.d(text);
    if (button === "{bksp}") jamoArray.pop(); else if (button === "{space}") jamoArray.push(" "); else if (button === "{enter}") jamoArray.push("\n"); else jamoArray.push(button);
    activeVirtualInput.value = Hangul.a(jamoArray);
    if (isKeyboardShift && button !== "{shift}") { isKeyboardShift = false; keyboard.setOptions({ layoutName: "default" }); }
}
function showKeyboard(targetId) { document.getElementById('keyboard-wrap').classList.add('show'); activeVirtualInput = document.getElementById(targetId); activeVirtualInput.focus(); }
function closeKeyboard() { document.getElementById('keyboard-wrap').classList.remove('show'); }
document.getElementById('autoInput').addEventListener('focus', function() { activeVirtualInput = this; });
document.getElementById('autoTransKr').addEventListener('focus', function() { activeVirtualInput = this; });
document.getElementById('listenInput').addEventListener('focus', function() { activeVirtualInput = this; });

async function initDatabase() {
    let storedExp = await localforage.getItem("expData"); if(storedExp) { exp = storedExp.exp; level = storedExp.level; }
    let storedSets = await localforage.getItem("vocabSets"); if(storedSets) vocabSets = storedSets;
    updateExpUI();
    let storedActiveIds = await localforage.getItem("activeSetIds");
    if(storedActiveIds && storedActiveIds.length > 0) activeSetIds = storedActiveIds.filter(id => vocabSets.some(set => set.id === id));
    else if(vocabSets.length > 0) activeSetIds = [vocabSets[0].id];
    updateCombinedVocab(false);
}
initDatabase();
function saveProgress() { localforage.setItem("expData", {exp, level}); }

function renderSetsList() {
    const listEl = document.getElementById('vocabSetsList'); document.getElementById('setCountText').innerText = vocabSets.length;
    if(vocabSets.length === 0) { listEl.innerHTML = "<p style='color:var(--text-muted); grid-column: 1/-1; font-size:15px;'>Th∆∞ vi·ªán tr·ªëng. B·∫°n h√£y th√™m b√†i h·ªçc nh√©.</p>"; return; }
    listEl.innerHTML = "";
    vocabSets.forEach(set => {
        let isActive = activeSetIds.includes(set.id);
        let checkIcon = isActive ? '<i class="fa-solid fa-circle-check" style="color:var(--primary);"></i>' : '';
        let itemBg = isActive ? 'background: var(--primary-light); border-color: #C7D2FE;' : 'background: white; border: 1px solid var(--border);';
        listEl.innerHTML += `<div style="padding: 22px; border-radius: 14px; cursor: pointer; position: relative; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.02); ${itemBg}" onclick="toggleSet('${set.id}')"><div style="font-weight: 700; font-size: 17px; margin-bottom: 4px; padding-right: 70px; color: var(--text);">${set.name} ${checkIcon}</div><div style="font-size: 14px; color: var(--text-muted); font-weight: 500;">${set.data.length} t·ª´ v·ª±ng</div><div style="position: absolute; top: 20px; right: 15px; display: flex; gap: 8px;"><button class="basic-btn" style="padding: 8px 12px; font-size: 13px; border-radius: 8px;" onclick="openEditModal('${set.id}', event)"><i class="fa-solid fa-pen"></i></button><button class="basic-btn" style="padding: 8px 12px; font-size: 13px; color: var(--danger); border-radius: 8px;" onclick="deleteSet('${set.id}', event)"><i class="fa-solid fa-trash-can"></i></button></div></div>`;
    });
}
function toggleSet(id) { if(activeSetIds.includes(id)) activeSetIds=activeSetIds.filter(x=>x!==id); else activeSetIds.push(id); updateCombinedVocab(true); }
function updateCombinedVocab(save = true) { vocab=[]; vocabSets.forEach(s=>{ if(activeSetIds.includes(s.id)) vocab=vocab.concat(s.data); }); if(save) localforage.setItem("activeSetIds", activeSetIds); renderSetsList(); document.getElementById('libraryCard').classList.remove('hide'); listenIndex = 0; }
function deleteSet(id, e) { e.stopPropagation(); if(confirm("X√≥a b√†i h·ªçc n√†y?")){ vocabSets=vocabSets.filter(s=>s.id!==id); localforage.setItem("vocabSets", vocabSets); activeSetIds=activeSetIds.filter(x=>x!==id); updateCombinedVocab(true); } }

function openCreateModal() { editingSetId = null; document.getElementById('modalTitle').innerHTML = 'T·∫°o B√†i M·ªõi'; document.getElementById('editSetName').value = ""; document.getElementById('editSetWords').innerHTML = ""; addNewEditRow(); addNewEditRow(); document.getElementById('editModal').classList.remove('hide'); }
function openEditModal(id, e) { e.stopPropagation(); editingSetId = id; document.getElementById('modalTitle').innerHTML = 'S·ª≠a B√†i H·ªçc'; let set = vocabSets.find(s => s.id === id); document.getElementById('editSetName').value = set.name; let html = ''; set.data.forEach((w) => { html += `<div class="edit-word-row"><input type="text" class="edit-kr" value="${w.kr}" style="padding:14px; border-radius:10px; border:1px solid var(--border-hover); font-family:inherit; font-size:15px;"><input type="text" class="edit-pr" value="${w.pr || ''}" style="padding:14px; border-radius:10px; border:1px solid var(--border-hover); font-family:inherit; font-size:15px;"><input type="text" class="edit-vi" value="${w.vi}" style="padding:14px; border-radius:10px; border:1px solid var(--border-hover); font-family:inherit; font-size:15px;"><button onclick="this.parentElement.remove()" class="basic-btn" style="color: var(--danger); padding: 14px; border-radius:10px;"><i class="fa-solid fa-xmark"></i></button></div>`; }); document.getElementById('editSetWords').innerHTML = html; document.getElementById('editModal').classList.remove('hide'); }
function addNewEditRow() { let row = document.createElement('div'); row.className = 'edit-word-row'; row.innerHTML = `<input type="text" class="edit-kr" placeholder="H√†n" style="padding:14px; border-radius:10px; border:1px solid var(--border-hover); font-family:inherit; font-size:15px;"><input type="text" class="edit-pr" placeholder="Phi√™n √¢m" style="padding:14px; border-radius:10px; border:1px solid var(--border-hover); font-family:inherit; font-size:15px;"><input type="text" class="edit-vi" placeholder="Vi·ªát" style="padding:14px; border-radius:10px; border:1px solid var(--border-hover); font-family:inherit; font-size:15px;"><button onclick="this.parentElement.remove()" class="basic-btn" style="color: var(--danger); padding: 14px; border-radius:10px;"><i class="fa-solid fa-xmark"></i></button>`; document.getElementById('editSetWords').appendChild(row); document.getElementById('editSetWords').scrollTop = document.getElementById('editSetWords').scrollHeight; }
async function saveEditSet() { let setName = document.getElementById('editSetName').value.trim() || "B√†i h·ªçc m·ªõi"; let newData = []; document.querySelectorAll('#editSetWords .edit-word-row').forEach((r) => { let kr = r.querySelector('.edit-kr').value.trim(); let pr = r.querySelector('.edit-pr').value.trim(); let vi = r.querySelector('.edit-vi').value.trim(); if(kr !== "" && vi !== "") newData.push({kr, pr, vi}); }); if(newData.length === 0) return showToast("Nh·∫≠p √≠t nh·∫•t 1 t·ª´ nh√©!", "error"); if (editingSetId === null) { let newId = Date.now().toString(); vocabSets.push({id: newId, name: setName, data: newData}); activeSetIds.push(newId); } else { let set = vocabSets.find(s => s.id === editingSetId); set.name = setName; set.data = newData; } await localforage.setItem("vocabSets", vocabSets); updateCombinedVocab(true); closeEditModal(); }
function closeEditModal() { document.getElementById('editModal').classList.add('hide'); }
function loadExcel() { let f = document.getElementById('file').files[0]; if(!f) return; let setName = prompt("T√™n b√†i h·ªçc:", f.name.replace(/\.[^/.]+$/, "")) || "B√†i h·ªçc"; let r = new FileReader(); r.onload = async e => { let ws = XLSX.read(e.target.result, {type: 'binary'}).Sheets[XLSX.read(e.target.result, {type: 'binary'}).SheetNames[0]]; let data = XLSX.utils.sheet_to_json(ws, {header: 1}); let newData = []; data.forEach((r) => { if(r[0] && r[2]) newData.push({kr: String(r[0]).trim(), pr: r[1] ? String(r[1]).trim() : "", vi: String(r[2]).trim()}); }); if(newData.length>0) { let id = Date.now().toString(); vocabSets.push({id:id, name:setName, data:newData}); await localforage.setItem("vocabSets", vocabSets); activeSetIds.push(id); updateCombinedVocab(true); showToast(`ƒê√£ t·∫£i ${newData.length} t·ª´!`); } document.getElementById('file').value = ""; }; r.readAsBinaryString(f); }

function showToast(msg, type = "info") { const t = document.getElementById('toast'); t.innerHTML = type === "error" ? `<i class="fa-solid fa-circle-exclamation" style="color:var(--danger); font-size: 18px;"></i> ${msg}` : `<i class="fa-solid fa-circle-check" style="color:var(--success); font-size: 18px;"></i> ${msg}`; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2500); }
function openScreen(id) { if(vocab.length === 0 && id !== "home") return showToast("B·∫°n ph·∫£i ch·ªçn b√†i h·ªçc tr∆∞·ªõc ƒë√£!", "error"); document.querySelectorAll('main > div:not(#toast):not(#keyboard-wrap):not(#editModal)').forEach(el => el.classList.add('hide')); let targetId = id.startsWith('quiz') ? 'quiz' : id; document.getElementById(targetId).classList.remove("hide"); closeKeyboard(); if(id == "flash") showFlash(); if(id == "match") startMatchGame(); if(id == "auto_write") generateNewAutoPrompt(); if(id == "listen") startListenGame(); if(id.startsWith("quiz")) startQuiz(id); }
function back() { document.querySelectorAll('main > div:not(#toast):not(#keyboard-wrap):not(#editModal)').forEach(el => el.classList.add('hide')); document.getElementById("home").classList.remove("hide"); closeKeyboard(); clearInterval(quizTimerInterval); }
function updateExpUI() { document.getElementById('level').innerText=level; document.getElementById('exp').innerText=exp; document.getElementById('bar').style.width=exp+"%"; }
function gain(x) { exp+=x; if(exp>=100){exp-=100; level++; showToast(`L√™n c·∫•p ${level}!`); playSuccessSound();} updateExpUI(); saveProgress(); }

function startListenGame() { if(vocab.length === 0) return; if(listenIndex >= vocab.length) listenIndex = 0; document.getElementById('listenCounterText').innerText = `${listenIndex + 1}/${vocab.length}`; document.getElementById('listenInput').value = ''; document.getElementById('listenResult').innerText = ''; playListenAudio(); }
function playListenAudio() { if(vocab.length === 0) return; speechSynthesis.cancel(); let u = new SpeechSynthesisUtterance(vocab[listenIndex].kr); u.lang = "ko-KR"; u.rate = 0.8; speechSynthesis.speak(u); }
function checkListen() { let ans = document.getElementById('listenInput').value.trim(); let resBox = document.getElementById('listenResult'); if(!ans) return showToast("B·∫°n ch∆∞a nh·∫≠p ƒë√°p √°n", "error"); let correctWord = vocab[listenIndex]; if(ans === correctWord.kr) { resBox.innerHTML = `<span style="color:var(--success)"><i class="fa-solid fa-check"></i> Ch√≠nh x√°c: ${correctWord.vi}</span>`; playSuccessSound(); gain(15); listenIndex++; setTimeout(startListenGame, 1200); } else { resBox.innerHTML = `<span style="color:var(--danger)"><i class="fa-solid fa-xmark"></i> Sai. ƒê√°p √°n: <b>${correctWord.kr}</b></span>`; } }
function skipListenGame() { document.getElementById('listenResult').innerHTML = `<span style="color:var(--text-muted)">ƒê√°p √°n: <b>${vocab[listenIndex].kr}</b></span>`; listenIndex++; setTimeout(startListenGame, 1200); }

async function callVercelBackend(promptText) {
    try {
        const response = await fetch(`/api/gemini`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
        });
        const data = await response.json(); 
        if (!response.ok) throw new Error(data.error || "L·ªói m√°y ch·ªß Vercel");
        return data.candidates[0].content.parts[0].text;
    } catch (e) {
        throw e;
    }
}

function generateNewAutoPrompt() { currentAIWord = vocab[Math.floor(Math.random() * vocab.length)]; document.getElementById('autoWordKr').innerText = currentAIWord.kr; document.getElementById('autoWordVi').innerText = `(${currentAIWord.vi})`; document.getElementById('autoInput').value = ""; document.getElementById('autoResult').style.display = "none"; }
async function checkSentenceBasic() { let u = document.getElementById('autoInput').value.trim(); if(!u) return showToast("B·∫°n ch∆∞a vi·∫øt c√¢u", "error"); let b = document.getElementById('basicCheckBtn'); let r = document.getElementById('autoResult'); b.innerHTML = `<span class="loader" style="border-top-color:var(--text);"></span>...`; b.disabled = true; try { let c = u.replace(/\s+/g, '').includes(currentAIWord.kr.replace(/\s+/g, '')); const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=vi&dt=t&q=${encodeURIComponent(u)}`); const d = await res.json(); let v = d[0].map(x => x[0]).join(''); let h = `<div style="font-size:15px; margin-bottom:15px;"><p style="color:var(--text-muted); font-weight: 600; margin-bottom:5px;">Google D·ªãch hi·ªÉu c√¢u c·ªßa b·∫°n l√†:</p><p style="font-size:18px; font-weight:700; color:var(--text); margin-top:0;">"${v}"</p></div>`; if (c) { h += `<div style="color:var(--success); font-weight:600; font-size:15px;"><i class="fa-solid fa-check"></i> ƒê√£ d√πng t·ª´ y√™u c·∫ßu.</div>`; playSuccessSound(); gain(10); } else { h += `<div style="color:var(--danger); font-weight:600; font-size:15px;"><i class="fa-solid fa-xmark"></i> Ch∆∞a d√πng t·ª´ y√™u c·∫ßu.</div>`; } r.innerHTML = h; r.style.display = "block"; } catch (e) { showToast("L·ªói k·∫øt n·ªëi", "error"); } finally { b.innerHTML = `<i class="fa-solid fa-bolt"></i> D·ªãch Nhanh`; b.disabled = false; } }

// PROMPT AI ƒê√É ƒê∆Ø·ª¢C CH·ªàNH S·ª¨A M√ÄU S·∫ÆC CHUY√äN NGHI·ªÜP TR·∫¶M ·∫§M
async function checkSentenceAI() { 
    let u = document.getElementById('autoInput').value.trim(); 
    if(!u) return showToast("B·∫°n ch∆∞a vi·∫øt c√¢u", "error"); 
    let b = document.getElementById('aiCheckBtn'); let r = document.getElementById('autoResult'); 
    b.innerHTML = `<span class="loader"></span>...`; b.disabled = true; 
    
    let p = `ƒê√≥ng vai gi√°o vi√™n ti·∫øng H√†n. Y√™u c·∫ßu d√πng t·ª´: "${currentAIWord.kr}" (${currentAIWord.vi}). H·ªçc vi√™n vi·∫øt: "${u}".
    TR·∫¢ L·ªúI NG·∫ÆN G·ªåN B·∫∞NG HTML (D√πng th·∫ª div, b, span. KH√îNG d√πng markdown). D√πng m√†u s·∫Øc chuy√™n nghi·ªáp (Xanh Navy ƒë·∫≠m: #1E3A8A, ƒê·ªè ƒë√¥: #991B1B, Xanh r√™u: #166534). KH√îNG d√πng m√†u ch√≥i. KH√îNG ch√†o h·ªèi.
    Ph·∫£i c√≥ ƒë√∫ng 3 m·ª•c:
    1. <div style="margin-bottom:10px;"><b><span style="color:#1E3A8A;">1. Nh·∫≠n x√©t:</span></b> (ƒê√°nh gi√° nghƒ©a, ng·ªØ c·∫£nh, c√≥ d√πng t·ª´ y√™u c·∫ßu ch∆∞a).</div>
    2. <div style="margin-bottom:10px;"><b><span style="color:#991B1B;">2. Ng·ªØ ph√°p & L·ªói sai:</span></b> (Ch·ªâ ra l·ªói chia ƒëu√¥i c√¢u, vi·∫øt t√°ch/li·ªÅn. Gi·∫£i th√≠ch g·ªçn. N·∫øu ƒë√∫ng 100% th√¨ khen).</div>
    3. <div style="margin-top:15px; padding:15px; background:#F9FAFB; border-radius:10px; border: 1px solid #E5E7EB;"><b><span style="color:#166534;">üí° C√¢u t·ª± nhi√™n nh·∫•t:</span></b> <br><span style="font-size: 18px; font-weight: 700; color: #111827;">(Vi·∫øt l·∫°i c√¢u chu·∫©n x√°c c·ªßa ng∆∞·ªùi H√†n)</span></div>
    QUAN TR·ªåNG: 100% L·ªùi ƒë√°nh gi√° ph·∫£i b·∫±ng Ti·∫øng Vi·ªát.`; 
    
    try { 
        let reply = await callVercelBackend(p);
        r.innerHTML = reply.replace(/```html/g, "").replace(/```/g, ""); 
        r.style.display = "block"; gain(20); playSuccessSound();
    } catch (e) { r.innerHTML = `<div style="color:var(--danger); font-weight: 600;">L·ªói: ${e.message}.</div>`; r.style.display = "block"; } 
    finally { b.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i> AI Ph√¢n T√≠ch`; b.disabled = false; } 
}

function resetAutoTranslation() { document.getElementById('autoTransVi').value = ''; document.getElementById('autoTransKr').value = ''; document.getElementById('autoTransResult').style.display = 'none'; }
async function checkTranslationBasic() { let v = document.getElementById('autoTransVi').value.trim(); let k = document.getElementById('autoTransKr').value.trim(); if(!v || !k) return showToast("Nh·∫≠p ƒë·ªß 2 √¥", "error"); let b = document.getElementById('basicTransBtn'); let r = document.getElementById('autoTransResult'); b.innerHTML = `<span class="loader" style="border-top-color:var(--text);"></span>...`; b.disabled = true; try { const r1 = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=vi&tl=ko&dt=t&q=${encodeURIComponent(v)}`); const d1 = await r1.json(); let c = d1[0].map(x => x[0]).join(''); const r2 = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=vi&dt=t&q=${encodeURIComponent(k)}`); const d2 = await r2.json(); let u = d2[0].map(x => x[0]).join(''); r.innerHTML = `<p style="color:var(--text-muted); font-size:14px; font-weight:600; margin-bottom:5px;">Google d·ªãch sang Ti·∫øng H√†n l√†:</p><p style="font-size:18px; font-weight:700; color:var(--text); margin-top:0;">${c}</p><div style="background: #F9FAFB; padding: 15px; border-radius: 12px; margin-top:15px; border: 1px solid var(--border);"><p style="color:var(--text-muted); font-size:13px; font-weight: 600; margin-top:0;">Nghƒ©a c√¢u H√†n b·∫°n v·ª´a vi·∫øt l√†:</p><p style="font-style:italic; font-size: 16px; margin-bottom:0; color: var(--text);">"${u}"</p></div>`; r.style.display = "block"; gain(10); playSuccessSound(); } catch (e) { showToast("L·ªói m·∫°ng", "error"); } finally { b.innerHTML = `<i class="fa-solid fa-bolt"></i> D·ªãch Google`; b.disabled = false; } }

async function checkTranslationAI() { 
    let v = document.getElementById('autoTransVi').value.trim(); let k = document.getElementById('autoTransKr').value.trim(); 
    if(!v || !k) return showToast("Nh·∫≠p ƒë·ªß 2 √¥", "error"); 
    let b = document.getElementById('aiTransBtn'); let r = document.getElementById('autoTransResult'); 
    b.innerHTML = `<span class="loader"></span>...`; b.disabled = true; 
    
    let p = `ƒê√≥ng vai chuy√™n gia ti·∫øng H√†n. C√¢u g·ªëc: "${v}". H·ªçc vi√™n d·ªãch: "${k}".
    TR·∫¢ L·ªúI NG·∫ÆN G·ªåN B·∫∞NG HTML (D√πng th·∫ª div, b, span). D√πng m√†u s·∫Øc chuy√™n nghi·ªáp (Xanh Navy ƒë·∫≠m: #1E3A8A, ƒê·ªè ƒë√¥: #991B1B, Xanh r√™u: #166534). KH√îNG d√πng markdown. KH√îNG C√ì L·ªúI CH√ÄO.
    Ph·∫£i c√≥ ƒë√∫ng 3 m·ª•c:
    1. <div style="margin-bottom:10px;"><b><span style="color:#1E3A8A;">1. M·ª©c ƒë·ªô s√°t nghƒ©a:</span></b> (B·∫£n d·ªãch n√†y c√≥ chu·∫©n √Ω ti·∫øng Vi·ªát kh√¥ng?)</div>
    2. <div style="margin-bottom:10px;"><b><span style="color:#991B1B;">2. Ph√¢n t√≠ch L·ªói:</span></b> (Ch·ªâ ra l·ªói sai chi ti·∫øt v·ªÅ ng·ªØ ph√°p, t·ª´ v·ª±ng ho·∫∑c c√°ch vi·∫øt t√°ch/li·ªÅn ch·ªØ).</div>
    3. <div style="margin-top:15px; padding:15px; background:#ECFDF5; border:1px solid #A7F3D0; border-radius:10px;"><b><span style="color:#047857;">üí° C√¢u d·ªãch ho√†n h·∫£o:</span></b><br><span style="font-size:20px; font-weight:700; color:var(--text); display:block; margin-top:5px;">(Vi·∫øt c√¢u ti·∫øng H√†n c·ª±c chu·∫©n v√†o ƒë√¢y)</span></div>
    QUAN TR·ªåNG: 100% L·ªùi gi·∫£i th√≠ch ph·∫£i l√† Ti·∫øng Vi·ªát.`; 
    
    try { 
        let reply = await callVercelBackend(p);
        r.innerHTML = reply.replace(/```html/g, "").replace(/```/g, ""); 
        r.style.display = "block"; gain(20); playSuccessSound();
    } catch (e) { r.innerHTML = `<div style="color:var(--danger); font-weight: 600;">L·ªói: ${e.message}</div>`; r.style.display = "block"; } 
    finally { b.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i> AI Ph√¢n T√≠ch`; b.disabled = false; } 
}

function showFlash() { let v = vocab[index]; document.getElementById('flashCounter').innerText = `${index + 1}/${vocab.length}`; document.getElementById('flashWord').innerText = v.kr; document.getElementById('flashPr').innerText = v.pr ? `[${v.pr}]` : ""; document.getElementById('flashMean').innerText = v.vi; }
function speak() { speechSynthesis.cancel(); let u = new SpeechSynthesisUtterance(vocab[index].kr); u.lang = "ko-KR"; speechSynthesis.speak(u); }
function next() { index = (index + 1) % vocab.length; showFlash(); }
function prev() { index = (index - 1 + vocab.length) % vocab.length; showFlash(); }

function startQuiz(type = 'quiz_kr_vi') { 
    currentQuizType = type;
    if(vocab.length < 4) { back(); return showToast("C·∫ßn √≠t nh·∫•t 4 t·ª´ ƒë·ªÉ ch∆°i", "error"); } 
    
    clearInterval(quizTimerInterval);
    quizStartTime = Date.now();
    document.getElementById('quizTimer').innerText = '0';
    quizTimerInterval = setInterval(() => { document.getElementById('quizTimer').innerText = Math.floor((Date.now() - quizStartTime) / 1000); }, 1000);

    let q = vocab[Math.floor(Math.random() * vocab.length)], opts = [q]; 
    while(opts.length < 4) { let r = vocab[Math.floor(Math.random() * vocab.length)]; if(!opts.includes(r)) opts.push(r); } 
    opts.sort(() => Math.random() - 0.5); 
    let html = `<div class="quiz-title">${type === 'quiz_kr_vi' ? `${q.kr} ${q.pr ? `<span class="pr-text">[${q.pr}]</span>` : ''}` : q.vi}</div><div class="quiz-grid">`; 
    opts.forEach(o => {
        let optText = type === 'quiz_kr_vi' ? o.vi : `${o.kr} ${o.pr ? `<span class="pr-text">[${o.pr}]</span>` : ''}`;
        html += `<div class='quiz-option' onclick='checkQuiz(this,"${btoa(encodeURIComponent(type === 'quiz_kr_vi' ? o.vi : o.kr))}","${btoa(encodeURIComponent(type === 'quiz_kr_vi' ? q.vi : q.kr))}")'>${optText}</div>`;
    }); 
    document.getElementById('quizBox').innerHTML = html + `</div>`; 
}

function checkQuiz(e, s, c) { 
    clearInterval(quizTimerInterval);
    let timeTaken = Math.floor((Date.now() - quizStartTime) / 1000);

    if(s === c) { 
        e.style.background = "var(--success-light)"; e.style.borderColor = "var(--success)"; e.style.color = "#047857"; 
        gain(10); 
        playSuccessSound();
        setTimeout(() => startQuiz(currentQuizType), 800); 
    } 
    else { 
        e.style.background = "var(--danger-light)"; e.style.borderColor = "var(--danger)"; e.style.color = "#B91C1C";
        setTimeout(() => startQuiz(currentQuizType), 1200); 
    } 
}

let mC = 0; 
function startMatchGame() { if(vocab.length < 3) { back(); return showToast("C·∫ßn √≠t nh·∫•t 3 t·ª´", "error"); } mC = 0; let m = document.getElementById('matchBox'); m.innerHTML = ""; let p = [...vocab].sort(() => Math.random() - 0.5).slice(0, 3); let a = [...p.map(v => ({t: v.kr, id: v.kr})), ...p.map(v => ({t: v.vi, id: v.kr}))].sort(() => Math.random() - 0.5); a.forEach(x => { let d = document.createElement("div"); d.className = "match-box"; d.innerText = x.t; d.onclick = () => pM(d, x.id); m.appendChild(d); }); }
function pM(d, id) { if(d.classList.contains('hidden') || d.classList.contains('selected')) return; if(!selected) { selected = {d, id}; d.classList.add("selected"); } else { if(selected.id === id) { d.style.background = "var(--success-light)"; d.style.borderColor = "var(--success)"; d.style.color = "#047857"; selected.d.style.background = "var(--success-light)"; selected.d.style.borderColor = "var(--success)"; selected.d.style.color = "#047857"; gain(15); playSuccessSound(); setTimeout(() => { d.classList.add("hidden"); selected.d.classList.add("hidden"); selected = null; mC += 2; if(mC >= 6) setTimeout(startMatchGame, 500); }, 500); } else { d.style.background = "var(--danger-light)"; d.style.borderColor = "var(--danger)"; d.style.color = "#B91C1C"; selected.d.style.background = "var(--danger-light)"; selected.d.style.borderColor = "var(--danger)"; selected.d.style.color = "#B91C1C"; setTimeout(() => { d.style.background = "#F9FAFB"; d.style.borderColor = "var(--border)"; d.style.color = "var(--text)"; selected.d.style.background = "#F9FAFB"; selected.d.style.borderColor = "var(--border)"; selected.d.style.color = "var(--text)"; selected.d.classList.remove("selected"); selected = null; }, 600); } } }
</script>
</body>
</html>
