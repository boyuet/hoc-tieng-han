<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Korean Trainer PRO+ (Professional Version)</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/css/index.css">
<script src="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/index.js"></script>
<script src="https://unpkg.com/hangul-js" type="text/javascript"></script>

<style>
    /* B·∫¢NG M√ÄU CHUY√äN NGHI·ªÜP HI·ªÜN ƒê·∫†I */
    :root {
        --bg: #f8fafc; 
        --card: #ffffff; 
        --border: #e2e8f0;
        --primary: #2563eb; 
        --primary-hover: #1d4ed8;
        --success: #059669; 
        --danger: #dc2626; 
        --ai: #8b5cf6; 
        --text: #0f172a; 
        --text-muted: #64748b;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 50px; line-height: 1.6;}
    
    /* M·ªû R·ªòNG GIAO DI·ªÜN L√äN 1100PX CHO M√ÅY T√çNH */
    header { background: linear-gradient(135deg, #1e293b, #0f172a); color: white; padding: 20px; font-size: 24px; text-align: center; font-weight: 700; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); letter-spacing: 0.5px;}
    main { max-width: 1100px; margin: 30px auto; padding: 0 20px; }
    
    /* CARD SANG TR·ªåNG */
    .card { background: var(--card); border-radius: 16px; padding: 30px; margin-bottom: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05); border: 1px solid var(--border); }
    .header-card { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;}
    
    /* N√öT B·∫§M MINIMALIST */
    button { background: var(--primary); border: none; padding: 12px 24px; border-radius: 10px; color: white; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; justify-content: center;}
    button:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);}
    button:active { transform: translateY(0); }
    button.ai-btn { background: linear-gradient(135deg, #8b5cf6, #6366f1); }
    button.ai-btn:hover { background: linear-gradient(135deg, #7c3aed, #4f46e5); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);}
    button.basic-btn { background: white; color: var(--text); border: 1px solid var(--border); }
    button.basic-btn:hover { background: #f1f5f9; border-color: #cbd5e1; box-shadow: none;}
    .btn-icon { padding: 12px; border-radius: 10px; font-size: 18px; }
    
    /* L∆Ø·ªöI MENU CH√çNH */
    .grid-center-container { display: flex; justify-content: center; width: 100%; margin-top: 30px;}
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; width: 100%;}
    .big-btn { font-size: 18px; padding: 25px 20px; border-radius: 16px; justify-content: center; flex-direction: column; gap: 15px; background: white; border: 1px solid var(--border); text-align: center; color: var(--text); box-shadow: 0 2px 4px rgba(0,0,0,0.02); font-weight: 600;}
    .big-btn i { font-size: 36px; color: var(--primary); transition: transform 0.3s ease;}
    .big-btn:hover { border-color: #93c5fd; background: #eff6ff; }
    .big-btn:hover i { transform: scale(1.1); }
    
    .progress-wrap { background: #f1f5f9; height: 12px; border-radius: 10px; overflow: hidden; margin-top: 10px;}
    .bar { background: var(--success); height: 100%; width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    
    /* FLASHCARD HI·ªÜN ƒê·∫†I */
    .flash-container { text-align: center; min-height: 300px; display: flex; flex-direction: column; justify-content: center; background: #ffffff; border-radius: 20px; padding: 40px; margin: 20px 0; position: relative; border: 1px solid #e2e8f0; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); }
    .flash-counter { position: absolute; top: 20px; left: 20px; font-size: 14px; color: var(--text-muted); font-weight: 600; background: #f1f5f9; padding: 6px 16px; border-radius: 20px;}
    .flash-word { font-size: 60px; font-weight: 800; margin-bottom: 10px; color: var(--text); letter-spacing: -1px;}
    .flash-pr { font-size: 22px; color: var(--text-muted); font-style: italic; margin-bottom: 25px; }
    .flash-vi { font-size: 32px; color: var(--success); font-weight: 700; }
    
    /* GAME TR·∫ÆC NGHI·ªÜM & GH√âP C·∫∂P */
    .quiz-title { font-size: 36px; text-align: center; margin: 30px 0 40px 0; font-weight: 800; color: var(--text); }
    .quiz-title .pr-text { display: block; font-size: 20px; color: var(--text-muted); font-weight: normal; margin-top: 8px; font-style: italic; }
    .quiz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 800px; margin: 0 auto;}
    .quiz-option { background: white; padding: 25px 20px; border-radius: 16px; cursor: pointer; text-align: center; font-size: 22px; font-weight: 600; border: 2px solid var(--border); transition: all 0.2s; color: var(--text);}
    .quiz-option:hover { border-color: var(--primary); background: #f8fafc; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05);}
    .quiz-option .pr-text { font-size: 16px; color: var(--text-muted); font-weight: normal; margin-top: 5px; font-style: italic; }
    
    .match-container { display: flex; justify-content: center; align-items: center; padding: 20px 0; }
    .match-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; max-width: 900px; }
    .match-box { background: white; padding: 25px 15px; border-radius: 12px; text-align: center; cursor: pointer; font-size: 20px; font-weight: 600; border: 2px solid var(--border); transition: all 0.2s; color: var(--text); display: flex; align-items: center; justify-content: center; min-height: 80px;}
    .match-box:hover { border-color: var(--primary); background: #f8fafc; }
    .match-box.selected { background: var(--primary); border-color: var(--primary); color: white; transform: scale(1.02); }
    .match-box.hidden { visibility: hidden; opacity: 0; pointer-events: none;}
    
    /* KHUNG NH·∫¨P LI·ªÜU R·ªòNG R√ÉI */
    .ai-write-container { padding: 10px; width: 100%; box-sizing: border-box;}
    .ai-target-word { font-size: 42px; color: var(--primary); font-weight: 800; margin: 15px 0 5px 0; text-align: center;}
    .ai-target-vi { font-size: 20px; color: var(--text-muted); font-weight: 600; margin-bottom: 30px; text-align: center;}
    .ai-custom-input, .ai-textarea { width: 100%; padding: 20px; font-size: 18px; border-radius: 12px; border: 2px solid var(--border); background: #ffffff; outline: none; box-sizing: border-box; margin-bottom: 20px; font-family: inherit; transition: border-color 0.2s; color: var(--text);}
    .ai-custom-input:focus, .ai-textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);}
    .ai-textarea { height: 150px; resize: vertical; }
    
    /* B·∫¢NG K·∫æT QU·∫¢ AI S·∫†CH S·∫º */
    .ai-result-box { margin-top: 30px; padding: 30px; background: #f8fafc; border-radius: 16px; text-align: left; font-size: 17px; line-height: 1.8; display: none; border: 1px solid var(--border); border-left: 5px solid var(--ai); color: var(--text);}
    .ai-result-box strong, .ai-result-box b { color: #1e293b; }
    
    .loader { border: 3px solid #e2e8f0; border-top: 3px solid white; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px;}
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* B√ÄN PH√çM & TOAST */
    #keyboard-wrap { position: fixed; bottom: 0; left: 0; width: 100%; background: #ffffff; padding: 20px 10px; box-sizing: border-box; z-index: 1000; display: none; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); border-top: 1px solid var(--border); }
    #keyboard-wrap.show { display: block; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .keyboard-close-btn { position: absolute; top: -45px; right: 20px; background: var(--text); color: white; border: none; padding: 8px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .hg-theme-default { font-family: inherit; background-color: transparent !important; color: var(--text); max-width: 900px; margin: 0 auto; }
    .hg-theme-default .hg-button { background: white !important; color: var(--text) !important; border: 1px solid var(--border) !important; border-bottom: 3px solid var(--border) !important; border-radius: 8px !important; font-size: 20px; height: 50px !important; font-weight: 500;}
    .hg-theme-default .hg-button:active { border-bottom-width: 1px !important; transform: translateY(2px); }
    
    .hide { display: none !important; }
    #toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(100px); background: #1e293b; color: white; padding: 15px 30px; border-radius: 30px; font-size: 16px; font-weight: 600; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); z-index: 3000; opacity: 0; display: flex; align-items: center; gap: 10px;}
    #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    
    /* GIAO DI·ªÜN QU·∫¢N L√ù TH∆Ø M·ª§C */
    .sets-header { font-size: 20px; margin-bottom: 20px; color: var(--text); border-bottom: 2px solid var(--border); padding-bottom: 12px; font-weight: 700;}
    .sets-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
    .set-item { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; position: relative;}
    .set-item:hover { border-color: var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.02);}
    .set-item.active { border-color: var(--success); background: #f0fdf4; border-width: 2px;}
    .set-name { font-weight: 700; font-size: 18px; margin-bottom: 6px; padding-right: 70px; color: var(--text);}
    .set-count { font-size: 14px; color: var(--text-muted); }
    .set-actions { position: absolute; top: 18px; right: 15px; display: flex; gap: 8px; }
    .btn-icon-small { background: white; border: 1px solid var(--border); padding: 8px; font-size: 14px; cursor: pointer; color: var(--text-muted); border-radius: 6px; transition: 0.2s;}
    .btn-icon-small:hover { background: #f1f5f9; color: var(--text); }
    
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 2000; overflow-y: auto; padding: 20px; box-sizing: border-box; backdrop-filter: blur(4px); }
    .edit-word-row { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 12px; align-items: center;}
    .edit-word-row input { padding: 12px; border-radius: 8px; border: 1px solid var(--border); width: 100%; box-sizing: border-box; outline: none; font-size: 15px; font-family: inherit;}
</style>
</head>

<body>
<header><i class="fa-solid fa-graduation-cap"></i> Ti·∫øng H√†n PRO+</header>

<div id="editModal" class="modal-overlay hide">
    <div class="card" style="max-width: 900px; margin: 40px auto;">
        <h3 id="modalTitle" style="margin-top: 0; font-size: 22px; color: var(--text);"><i class="fa-solid fa-pen-to-square"></i> Qu·∫£n L√Ω Th∆∞ M·ª•c</h3>
        <p style="color: var(--text-muted); font-size: 15px; font-weight: 600; margin-bottom: 8px;">T√™n th∆∞ m·ª•c:</p>
        <input type="text" id="editSetName" class="ai-custom-input" placeholder="V√≠ d·ª•: B√†i 1..." style="padding: 15px;">
        <p style="color: var(--text-muted); font-size: 15px; font-weight: 600; margin-bottom: 8px;">Danh s√°ch t·ª´ v·ª±ng:</p>
        <div id="editSetWords" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px; padding: 15px; border: 1px solid var(--border); border-radius: 8px; background: #f8fafc;"></div>
        <button type="button" onclick="addNewEditRow()" class="basic-btn" style="width: 100%; margin-bottom: 25px;"><i class="fa-solid fa-plus"></i> Th√™m T·ª´ M·ªõi</button>
        <div style="display: flex; gap: 15px; justify-content: flex-end;">
            <button onclick="closeEditModal()" class="basic-btn"><i class="fa-solid fa-xmark"></i> H·ªßy</button>
            <button onclick="saveEditSet()"><i class="fa-solid fa-floppy-disk"></i> L∆∞u L·∫°i</button>
        </div>
    </div>
</div>

<div id="keyboard-wrap">
    <button class="keyboard-close-btn" onclick="closeKeyboard()"><i class="fa-solid fa-chevron-down"></i> ƒê√≥ng</button>
    <div class="simple-keyboard"></div>
</div>

<main>
    <div id="toast">Th√¥ng b√°o</div>

    <div id="home">
        <div class="card">
            <div class="header-card">
                <div>
                    <h2 style="margin: 0; color: var(--text); font-size: 24px;"><i class="fa-solid fa-award" style="color: var(--success);"></i> C·∫•p ƒë·ªô: <span id="level">1</span></h2>
                    <p style="margin: 6px 0 0 0; color: var(--text-muted); font-weight: 500; font-size: 15px;">Kinh nghi·ªám: <span id="exp">0</span> / 100</p>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <input type="file" id="file" class="hide" accept=".xlsx, .xls" onchange="loadExcel()">
                    <button onclick="document.getElementById('file').click()" class="basic-btn"><i class="fa-solid fa-file-excel" style="color: #16a34a;"></i> Nh·∫≠p Excel</button>
                    <button onclick="openCreateModal()" class="basic-btn"><i class="fa-solid fa-folder-plus" style="color: var(--primary);"></i> T·∫°o Th·ªß C√¥ng</button>
                </div>
            </div>
            <div class="progress-wrap"><div class="bar" id="bar"></div></div>
        </div>

        <div class="card" id="libraryCard" class="hide">
            <div class="sets-header"><i class="fa-solid fa-book-open" style="color: var(--text-muted);"></i> Th∆∞ vi·ªán c·ªßa b·∫°n (<span id="setCountText">0</span>) </div>
            <div id="vocabSetsList" class="sets-grid"></div>
        </div>

        <div class="grid-center-container">
            <div class="grid">
                <button class="big-btn" onclick="openScreen('flash')"><i class="fa-solid fa-layer-group" style="color: #3b82f6;"></i> Th·∫ª Ghi Nh·ªõ</button>
                <button class="big-btn" onclick="openScreen('listen')"><i class="fa-solid fa-headphones" style="color: #f59e0b;"></i> Nghe & ƒêi·ªÅn T·ª´</button>
                <button class="big-btn" onclick="openScreen('quiz_kr_vi')"><i class="fa-solid fa-spell-check" style="color: #10b981;"></i> Tr·∫Øc Nghi·ªám H√†n ‚ûî Vi·ªát</button>
                <button class="big-btn" onclick="openScreen('quiz_vi_kr')"><i class="fa-solid fa-language" style="color: #14b8a6;"></i> Tr·∫Øc Nghi·ªám Vi·ªát ‚ûî H√†n</button>
                <button class="big-btn" onclick="openScreen('match')"><i class="fa-solid fa-puzzle-piece" style="color: #8b5cf6;"></i> Gh√©p C·∫∑p T·ª´</button>
                <button class="big-btn" onclick="openScreen('auto_write')"><i class="fa-solid fa-pen-nib" style="color: #ec4899;"></i> AI Ch·∫•m C√¢u</button>
                <button class="big-btn" onclick="openScreen('auto_translate')" style="grid-column: 1 / -1;"><i class="fa-solid fa-comments" style="color: var(--text);"></i> D·ªãch T·ª± Do & Ch·ªØa L·ªói Ng·ªØ Ph√°p</button>
            </div>
        </div>
    </div>

    <div id="listen" class="hide">
        <div class="card">
            <button onclick="back()" class="basic-btn" style="margin-bottom: 20px;"><i class="fa-solid fa-arrow-left"></i> Quay l·∫°i</button>
            <div class="ai-write-container" style="max-width: 700px; margin: 0 auto;">
                <h2 style="color: var(--text); font-weight: 800; font-size: 28px; text-align: center;"><i class="fa-solid fa-headphones" style="color: #f59e0b;"></i> Luy·ªán Nghe</h2>
                <div style="text-align: center; color: var(--text-muted); font-weight: 600; margin-bottom: 30px;">C√¢u h·ªèi: <span id="listenCounterText">1/1</span></div>
                
                <div style="text-align: center; margin: 40px 0;"><button class="btn-icon" style="background: var(--primary); font-size: 32px; padding: 30px; border-radius: 50%;" onclick="playListenAudio()"><i class="fa-solid fa-volume-high"></i></button></div>
                
                <input type="text" id="listenInput" class="ai-custom-input" placeholder="G√µ ch√≠nh x√°c ti·∫øng H√†n b·∫°n nghe ƒë∆∞·ª£c..." autocomplete="off" style="text-align: center;">
                <div style="text-align: right; margin-bottom: 25px;"><button type="button" onclick="showKeyboard('listenInput')" class="basic-btn" style="padding: 8px 15px; font-size: 14px;"><i class="fa-solid fa-keyboard"></i> B√†n ph√≠m ·∫£o</button></div>
                
                <div style="display: flex; justify-content: center; gap: 15px;">
                    <button onclick="skipListenGame()" class="basic-btn"><i class="fa-solid fa-forward-step"></i> B·ªè qua</button>
                    <button onclick="checkListen()"><i class="fa-solid fa-check"></i> Ki·ªÉm Tra</button>
                </div>
                <div id="listenResult" style="margin-top: 30px; font-size: 22px; font-weight: 700; text-align: center; min-height: 30px;"></div>
            </div>
        </div>
    </div>

    <div id="auto_write" class="hide">
        <div class="card">
            <button onclick="back()" class="basic-btn"><i class="fa-solid fa-arrow-left"></i> Quay l·∫°i</button>
            <div class="ai-write-container">
                <p style="color: var(--text-muted); font-size: 18px; font-weight: 600; text-align: center; margin-top: 30px;">H√£y ƒë·∫∑t m·ªôt c√¢u ti·∫øng H√†n s·ª≠ d·ª•ng t·ª´:</p>
                <div class="ai-target-word" id="autoWordKr">---</div>
                <div class="ai-target-vi" id="autoWordVi">---</div>
                
                <textarea id="autoInput" class="ai-textarea" placeholder="Nh·∫≠p c√¢u ti·∫øng H√†n c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea>
                <div style="text-align: right; margin-bottom: 25px;"><button type="button" onclick="showKeyboard('autoInput')" class="basic-btn" style="padding: 8px 15px; font-size: 14px;"><i class="fa-solid fa-keyboard"></i> B√†n ph√≠m ·∫£o</button></div>
                
                <div style="display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
                    <button onclick="generateNewAutoPrompt()" class="basic-btn"><i class="fa-solid fa-rotate-right"></i> ƒê·ªïi t·ª´ kh√°c</button>
                    <button onclick="checkSentenceBasic()" class="basic-btn" id="basicCheckBtn" style="color: var(--primary); border-color: var(--primary);"><i class="fa-solid fa-bolt"></i> D·ªãch Nhanh</button>
                    <button onclick="checkSentenceAI()" class="ai-btn" id="aiCheckBtn"><i class="fa-solid fa-wand-magic-sparkles"></i> AI Ch·∫•m Chi Ti·∫øt</button>
                </div>
                <div id="autoResult" class="ai-result-box"></div>
            </div>
        </div>
    </div>

    <div id="auto_translate" class="hide">
        <div class="card">
            <button onclick="back()" class="basic-btn"><i class="fa-solid fa-arrow-left"></i> Quay l·∫°i</button>
            <div class="ai-write-container">
                <h2 style="text-align: center; color: var(--text); margin-bottom: 40px;">D·ªãch T·ª± Do & Ch·ªØa L·ªói</h2>
                
                <p style="color: var(--text); font-size: 16px; font-weight: 700; margin-bottom: 10px;">1. C√¢u Ti·∫øng Vi·ªát b·∫°n mu·ªën n√≥i:</p>
                <input type="text" id="autoTransVi" class="ai-custom-input" placeholder="V√≠ d·ª•: Cu·ªëi tu·∫ßn n√†y t√¥i ƒë·ªãnh ƒëi xem phim c√πng b·∫°n...">
                
                <p style="color: var(--text); font-size: 16px; font-weight: 700; margin-bottom: 10px; margin-top: 20px;">2. T·ª± d·ªãch sang Ti·∫øng H√†n theo c√°ch c·ªßa b·∫°n:</p>
                <textarea id="autoTransKr" class="ai-textarea" placeholder="T·ª± vi·∫øt b·∫±ng ti·∫øng H√†n..."></textarea>
                
                <div style="text-align: right; margin-bottom: 30px;"><button type="button" onclick="showKeyboard('autoTransKr')" class="basic-btn" style="padding: 8px 15px; font-size: 14px;"><i class="fa-solid fa-keyboard"></i> B√†n ph√≠m ·∫£o</button></div>
                
                <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <button onclick="resetAutoTranslation()" class="basic-btn" style="color: var(--danger);"><i class="fa-solid fa-trash-can"></i> X√≥a l√†m l·∫°i</button>
                    <button onclick="checkTranslationBasic()" class="basic-btn" id="basicTransBtn" style="color: var(--primary); border-color: var(--primary);"><i class="fa-solid fa-bolt"></i> ƒê·ªëi Chi·∫øu Nhanh</button>
                    <button onclick="checkTranslationAI()" class="ai-btn" id="aiTransBtn"><i class="fa-solid fa-wand-magic-sparkles"></i> AI Ph√¢n T√≠ch</button>
                </div>
                <div id="autoTransResult" class="ai-result-box"></div>
            </div>
        </div>
    </div>

    <div id="flash" class="hide">
        <div class="card">
            <button onclick="back()" class="basic-btn"><i class="fa-solid fa-arrow-left"></i> Quay l·∫°i</button>
            <div class="flash-container" style="max-width: 800px; margin: 30px auto;">
                <div class="flash-counter" id="flashCounter">1/1</div>
                <div class="flash-word" id="flashWord">---</div>
                <div class="flash-pr" id="flashPr"></div>
                <div class="flash-vi" id="flashMean">---</div>
            </div>
            <div class="flash-controls">
                <button class="basic-btn btn-icon" style="padding: 15px 25px;" onclick="prev()"><i class="fa-solid fa-chevron-left"></i></button>
                <button class="btn-icon" style="background: var(--success); padding: 15px 30px; font-size: 24px;" onclick="speak()"><i class="fa-solid fa-volume-high"></i></button>
                <button class="basic-btn btn-icon" style="padding: 15px 25px;" onclick="next()"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            <p style="text-align: center; color: var(--text-muted); font-size: 14px; margin-top: 20px;">*M·∫πo: L∆∞·ªõt th·∫ª ƒë·ªÉ ghi nh·ªõ kh√¥ng c·ªông ƒëi·ªÉm. H√£y l√†m b√†i t·∫≠p ƒë·ªÉ tƒÉng c·∫•p!</p>
        </div>
    </div>
    
    <div id="quiz" class="hide">
        <div class="card">
            <button onclick="back()" class="basic-btn"><i class="fa-solid fa-arrow-left"></i> Quay l·∫°i</button>
            <div style="text-align:center; font-size:16px; color:var(--primary); margin-top:20px; font-weight:700; background: #eff6ff; padding: 8px 20px; border-radius: 20px; width: fit-content; margin: 20px auto;"><i class="fa-regular fa-clock"></i> Th·ªùi gian: <span id="quizTimer">0</span>s</div>
            <div id="quizBox"></div>
        </div>
    </div>
    
    <div id="match" class="hide">
        <div class="card">
            <button onclick="back()" class="basic-btn"><i class="fa-solid fa-arrow-left"></i> Quay l·∫°i</button>
            <div class="match-container">
                <div class="match-grid" id="matchBox"></div>
            </div>
        </div>
    </div>
</main>

<script>
let vocabSets = []; let activeSetIds = []; let vocab = []; 
let index = 0, exp = 0, level = 1, selected = null; let currentAIWord = null; let editingSetId = null; let listenIndex = 0; 

let quizStartTime; let quizTimerInterval; let currentQuizType = 'quiz_kr_vi';

let keyboard; let activeVirtualInput = null; let isKeyboardShift = false;
document.addEventListener("DOMContentLoaded", () => {
    if(window.SimpleKeyboard) {
        keyboard = new window.SimpleKeyboard.default({
            theme: "hg-theme-default",
            layout: { 'default': ["„ÖÇ „Öà „Ñ∑ „Ñ± „ÖÖ „Öõ „Öï „Öë „Öê „Öî {bksp}", "„ÖÅ „Ñ¥ „Öá „Ñπ „Öé „Öó „Öì „Öè „Ö£ {enter}", "{shift} „Öã „Öå „Öä „Öç „Ö† „Öú „Ö° {shift}", "{space}"], 'shift': ["„ÖÉ „Öâ „Ñ∏ „Ñ≤ „ÖÜ „Öõ „Öï „Öë „Öí „Öñ {bksp}", "„ÖÅ „Ñ¥ „Öá „Ñπ „Öé „Öó „Öì „Öè „Ö£ {enter}", "{shift} „Öã „Öå „Öä „Öç „Ö† „Öú „Ö° {shift}", "{space}"] },
            display: { "{bksp}": "‚å´ X√≥a", "{enter}": "‚Üµ", "{shift}": "‚áß", "{space}": "D·∫•u C√°ch" },
            onKeyPress: button => handleVirtualKeyPress(button)
        });
    }
});
function handleVirtualKeyPress(button) {
    if (!activeVirtualInput) return;
    if (button === "{shift}") { isKeyboardShift = !isKeyboardShift; keyboard.setOptions({ layoutName: isKeyboardShift ? "shift" : "default" }); return; }
    let text = activeVirtualInput.value; let jamoArray = Hangul.d(text);
    if (button === "{bksp}") jamoArray.pop(); else if (button === "{space}") jamoArray.push(" "); else if (button === "{enter}") jamoArray.push("\n"); else jamoArray.push(button);
    activeVirtualInput.value = Hangul.a(jamoArray);
    if (isKeyboardShift && button !== "{shift}") { isKeyboardShift = false; keyboard.setOptions({ layoutName: "default" }); }
}
function showKeyboard(targetId) { document.getElementById('keyboard-wrap').classList.add('show'); activeVirtualInput = document.getElementById(targetId); activeVirtualInput.focus(); }
function closeKeyboard() { document.getElementById('keyboard-wrap').classList.remove('show'); }
document.getElementById('autoInput').addEventListener('focus', function() { activeVirtualInput = this; });
document.getElementById('autoTransKr').addEventListener('focus', function() { activeVirtualInput = this; });
document.getElementById('listenInput').addEventListener('focus', function() { activeVirtualInput = this; });

async function initDatabase() {
    let storedExp = await localforage.getItem("expData"); if(storedExp) { exp = storedExp.exp; level = storedExp.level; }
    let storedSets = await localforage.getItem("vocabSets"); if(storedSets) vocabSets = storedSets;
    updateExpUI();
    let storedActiveIds = await localforage.getItem("activeSetIds");
    if(storedActiveIds && storedActiveIds.length > 0) activeSetIds = storedActiveIds.filter(id => vocabSets.some(set => set.id === id));
    else if(vocabSets.length > 0) activeSetIds = [vocabSets[0].id];
    updateCombinedVocab(false);
}
initDatabase();
function saveProgress() { localforage.setItem("expData", {exp, level}); }

function renderSetsList() {
    const listEl = document.getElementById('vocabSetsList'); document.getElementById('setCountText').innerText = vocabSets.length;
    if(vocabSets.length === 0) { listEl.innerHTML = "<p style='color:var(--text-muted); grid-column: 1/-1; font-weight:500;'>Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng t·∫°o th∆∞ m·ª•c ho·∫∑c nh·∫≠p file Excel.</p>"; return; }
    listEl.innerHTML = "";
    vocabSets.forEach(set => {
        let isActive = activeSetIds.includes(set.id) ? 'active' : ''; let checkIcon = activeSetIds.includes(set.id) ? '<i class="fa-solid fa-circle-check" style="color:var(--success);"></i>' : '';
        listEl.innerHTML += `<div class="set-item ${isActive}" onclick="toggleSet('${set.id}')"><div class="set-name">${set.name} ${checkIcon}</div><div class="set-count">${set.data.length} t·ª´ v·ª±ng</div><div class="set-actions"><button class="btn-icon-small" onclick="openEditModal('${set.id}', event)"><i class="fa-solid fa-pen"></i></button><button class="btn-icon-small" onclick="deleteSet('${set.id}', event)" style="color: var(--danger);"><i class="fa-solid fa-trash-can"></i></button></div></div>`;
    });
}
function toggleSet(id) { if(activeSetIds.includes(id)) activeSetIds=activeSetIds.filter(x=>x!==id); else activeSetIds.push(id); updateCombinedVocab(true); }
function updateCombinedVocab(save = true) { vocab=[]; vocabSets.forEach(s=>{ if(activeSetIds.includes(s.id)) vocab=vocab.concat(s.data); }); if(save) localforage.setItem("activeSetIds", activeSetIds); renderSetsList(); document.getElementById('libraryCard').classList.remove('hide'); listenIndex = 0; }
function deleteSet(id, e) { e.stopPropagation(); if(confirm("X√≥a th∆∞ m·ª•c n√†y?")){ vocabSets=vocabSets.filter(s=>s.id!==id); localforage.setItem("vocabSets", vocabSets); activeSetIds=activeSetIds.filter(x=>x!==id); updateCombinedVocab(true); } }

function openCreateModal() { editingSetId = null; document.getElementById('modalTitle').innerHTML = '<i class="fa-solid fa-folder-plus"></i> T·∫°o M·ªõi'; document.getElementById('editSetName').value = ""; document.getElementById('editSetWords').innerHTML = ""; addNewEditRow(); addNewEditRow(); document.getElementById('editModal').classList.remove('hide'); }
function openEditModal(id, e) { e.stopPropagation(); editingSetId = id; document.getElementById('modalTitle').innerHTML = '<i class="fa-solid fa-pen"></i> S·ª≠a Th∆∞ M·ª•c'; let set = vocabSets.find(s => s.id === id); document.getElementById('editSetName').value = set.name; let html = ''; set.data.forEach((w) => { html += `<div class="edit-word-row"><input type="text" class="edit-kr" value="${w.kr}"><input type="text" class="edit-pr" value="${w.pr || ''}"><input type="text" class="edit-vi" value="${w.vi}"><button onclick="this.parentElement.remove()" class="basic-btn" style="color: var(--danger); border: none; background: #fee2e2; padding: 12px;"><i class="fa-solid fa-xmark"></i></button></div>`; }); document.getElementById('editSetWords').innerHTML = html; document.getElementById('editModal').classList.remove('hide'); }
function addNewEditRow() { let row = document.createElement('div'); row.className = 'edit-word-row'; row.innerHTML = `<input type="text" class="edit-kr" placeholder="H√†n"><input type="text" class="edit-pr" placeholder="Phi√™n √¢m"><input type="text" class="edit-vi" placeholder="Vi·ªát"><button onclick="this.parentElement.remove()" class="basic-btn" style="color: var(--danger); border: none; background: #fee2e2; padding: 12px;"><i class="fa-solid fa-xmark"></i></button>`; document.getElementById('editSetWords').appendChild(row); document.getElementById('editSetWords').scrollTop = document.getElementById('editSetWords').scrollHeight; }
async function saveEditSet() { let setName = document.getElementById('editSetName').value.trim() || "Th∆∞ m·ª•c"; let newData = []; document.querySelectorAll('#editSetWords .edit-word-row').forEach((r) => { let kr = r.querySelector('.edit-kr').value.trim(); let pr = r.querySelector('.edit-pr').value.trim(); let vi = r.querySelector('.edit-vi').value.trim(); if(kr !== "" && vi !== "") newData.push({kr, pr, vi}); }); if(newData.length === 0) return showToast("Nh·∫≠p √≠t nh·∫•t 1 t·ª´!", "error"); if (editingSetId === null) { let newId = Date.now().toString(); vocabSets.push({id: newId, name: setName, data: newData}); activeSetIds.push(newId); } else { let set = vocabSets.find(s => s.id === editingSetId); set.name = setName; set.data = newData; } await localforage.setItem("vocabSets", vocabSets); updateCombinedVocab(true); closeEditModal(); }
function closeEditModal() { document.getElementById('editModal').classList.add('hide'); }
function loadExcel() { let f = document.getElementById('file').files[0]; if(!f) return; let setName = prompt("T√™n th∆∞ m·ª•c:", f.name.replace(/\.[^/.]+$/, "")) || "Th∆∞ m·ª•c"; let r = new FileReader(); r.onload = async e => { let ws = XLSX.read(e.target.result, {type: 'binary'}).Sheets[XLSX.read(e.target.result, {type: 'binary'}).SheetNames[0]]; let data = XLSX.utils.sheet_to_json(ws, {header: 1}); let newData = []; data.forEach((r) => { if(r[0] && r[2]) newData.push({kr: String(r[0]).trim(), pr: r[1] ? String(r[1]).trim() : "", vi: String(r[2]).trim()}); }); if(newData.length>0) { let id = Date.now().toString(); vocabSets.push({id:id, name:setName, data:newData}); await localforage.setItem("vocabSets", vocabSets); activeSetIds.push(id); updateCombinedVocab(true); showToast(`ƒê√£ th√™m ${newData.length} t·ª´!`, "success"); } document.getElementById('file').value = ""; }; r.readAsBinaryString(f); }

function showToast(msg, type = "info") { const t = document.getElementById('toast'); t.innerHTML = type === "error" ? `<i class="fa-solid fa-circle-exclamation" style="color:#fca5a5;"></i> ${msg}` : `<i class="fa-solid fa-circle-check" style="color:#86efac;"></i> ${msg}`; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2500); }
function openScreen(id) { if(vocab.length === 0 && id !== "home") return showToast("Ch·ªçn th∆∞ m·ª•c ƒë·ªÉ h·ªçc!", "error"); document.querySelectorAll('main > div:not(#toast):not(#keyboard-wrap):not(#editModal)').forEach(el => el.classList.add('hide')); let targetId = id.startsWith('quiz') ? 'quiz' : id; document.getElementById(targetId).classList.remove("hide"); closeKeyboard(); if(id == "flash") showFlash(); if(id == "match") startMatchGame(); if(id == "auto_write") generateNewAutoPrompt(); if(id == "listen") startListenGame(); if(id.startsWith("quiz")) startQuiz(id); }
function back() { document.querySelectorAll('main > div:not(#toast):not(#keyboard-wrap):not(#editModal)').forEach(el => el.classList.add('hide')); document.getElementById("home").classList.remove("hide"); closeKeyboard(); clearInterval(quizTimerInterval); }
function updateExpUI() { document.getElementById('level').innerText=level; document.getElementById('exp').innerText=exp; document.getElementById('bar').style.width=exp+"%"; }
function gain(x) { exp+=x; if(exp>=100){exp-=100; level++; showToast(`L√™n c·∫•p ${level}!`, "success");} updateExpUI(); saveProgress(); }

function startListenGame() { if(vocab.length === 0) return; if(listenIndex >= vocab.length) listenIndex = 0; document.getElementById('listenCounterText').innerText = `${listenIndex + 1}/${vocab.length}`; document.getElementById('listenInput').value = ''; document.getElementById('listenResult').innerText = ''; playListenAudio(); }
function playListenAudio() { if(vocab.length === 0) return; speechSynthesis.cancel(); let u = new SpeechSynthesisUtterance(vocab[listenIndex].kr); u.lang = "ko-KR"; u.rate = 0.8; speechSynthesis.speak(u); }
function checkListen() { let ans = document.getElementById('listenInput').value.trim(); let resBox = document.getElementById('listenResult'); if(!ans) return showToast("G√µ ƒë√°p √°n!", "error"); let correctWord = vocab[listenIndex]; if(ans === correctWord.kr) { resBox.innerHTML = `<span style="color:var(--success)">Ch√≠nh x√°c: ${correctWord.vi}</span>`; gain(15); listenIndex++; setTimeout(startListenGame, 1200); } else { resBox.innerHTML = `<span style="color:var(--danger)">Sai! ƒê√°p √°n l√†: <b>${correctWord.kr}</b></span>`; } }
function skipListenGame() { document.getElementById('listenResult').innerHTML = `<span style="color:var(--text-muted)">ƒê√°p √°n: <b>${vocab[listenIndex].kr}</b></span>`; listenIndex++; setTimeout(startListenGame, 1200); }

async function callVercelBackend(promptText) {
    try {
        const response = await fetch(`/api/gemini`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
        });
        const data = await response.json(); 
        if (!response.ok) throw new Error(data.error || "L·ªói m√°y ch·ªß Vercel");
        return data.candidates[0].content.parts[0].text;
    } catch (e) {
        throw e;
    }
}

function generateNewAutoPrompt() { currentAIWord = vocab[Math.floor(Math.random() * vocab.length)]; document.getElementById('autoWordKr').innerText = currentAIWord.kr; document.getElementById('autoWordVi').innerText = `(${currentAIWord.vi})`; document.getElementById('autoInput').value = ""; document.getElementById('autoResult').style.display = "none"; }
async function checkSentenceBasic() { let u = document.getElementById('autoInput').value.trim(); if(!u) return showToast("Ch∆∞a vi·∫øt c√¢u!", "error"); let b = document.getElementById('basicCheckBtn'); let r = document.getElementById('autoResult'); b.innerHTML = `<span class="loader" style="border-top-color:var(--primary);"></span>...`; b.disabled = true; try { let c = u.replace(/\s+/g, '').includes(currentAIWord.kr.replace(/\s+/g, '')); const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=vi&dt=t&q=${encodeURIComponent(u)}`); const d = await res.json(); let v = d[0].map(x => x[0]).join(''); let h = `<div style="font-size:16px; margin-bottom:15px;"><p style="color:var(--text-muted); font-weight:600; margin-bottom:5px;">Google D·ªãch hi·ªÉu c√¢u c·ªßa b·∫°n l√†:</p><p style="font-size:20px; font-weight:700; color:var(--text); margin-top:0;">"${v}"</p></div>`; if (c) { h += `<div style="color:var(--success); font-weight:600;"><i class="fa-solid fa-check"></i> ƒê√£ d√πng t·ª´ y√™u c·∫ßu.</div>`; gain(10); } else { h += `<div style="color:var(--danger); font-weight:600;"><i class="fa-solid fa-xmark"></i> Ch∆∞a d√πng t·ª´ y√™u c·∫ßu!</div>`; } h += `<div style="margin-top:15px; font-size: 14px; color: var(--text-muted); font-style:italic;">*M·∫πo: B·∫•m "AI Ph√¢n T√≠ch" ƒë·ªÉ bi·∫øt c√¢u c√≥ ƒë√∫ng ng·ªØ ph√°p ti·∫øng H√†n kh√¥ng.</div>`; r.innerHTML = h; r.style.display = "block"; } catch (e) { showToast("L·ªói k·∫øt n·ªëi Google!", "error"); } finally { b.innerHTML = `<i class="fa-solid fa-bolt"></i> D·ªãch Nhanh`; b.disabled = false; } }

async function checkSentenceAI() { 
    let u = document.getElementById('autoInput').value.trim(); 
    if(!u) return showToast("Ch∆∞a vi·∫øt c√¢u!", "error"); 
    let b = document.getElementById('aiCheckBtn'); let r = document.getElementById('autoResult'); 
    b.innerHTML = `<span class="loader"></span>...`; b.disabled = true; 
    
    let p = `ƒê√≥ng vai gi√°o vi√™n ti·∫øng H√†n kh·∫Øt khe. Y√™u c·∫ßu h·ªçc vi√™n d√πng t·ª´: "${currentAIWord.kr}" (${currentAIWord.vi}). H·ªçc vi√™n v·ª´a vi·∫øt c√¢u n√†y: "${u}".
    TR·∫¢ L·ªúI NG·∫ÆN G·ªåN, ƒêI TH·∫≤NG V·∫§N ƒê·ªÄ B·∫∞NG HTML (ch·ªâ d√πng c√°c th·∫ª div, b, span m√†u s·∫Øc cho ƒë·∫πp). KH√îNG d√πng markdown markdown (nh∆∞ ** hay #). KH√îNG ch√†o h·ªèi luy√™n thuy√™n (kh√¥ng n√≥i "ch√†o b·∫°n", kh√¥ng l·∫∑p l·∫°i ƒë·ªÅ b√†i).
    Ph·∫£i c√≥ ƒë·ªß 4 m·ª•c sau:
    1. <div style="margin-bottom:10px;"><b><span style="color:#2563eb;">1. ƒê√°nh gi√°:</span></b> (Nh·∫≠n x√©t c√¢u n√†y ƒë√∫ng hay sai, nghƒ©a c√≥ t·ª± nhi√™n v√† ph√π h·ª£p ng·ªØ c·∫£nh kh√¥ng? N·∫øu kh√¥ng d√πng t·ª´ y√™u c·∫ßu th√¨ nh·∫Øc nh·ªü).</div>
    2. <div style="margin-bottom:10px;"><b><span style="color:#dc2626;">2. L·ªói Ng·ªØ ph√°p & Kho·∫£ng c√°ch:</span></b> (Ch·ªâ ra l·ªói sai ÎùÑÏñ¥Ïì∞Í∏∞ v√† ng·ªØ ph√°p chi ti·∫øt n·∫øu c√≥, gi·∫£i th√≠ch ng·∫Øn g·ªçn. N·∫øu ƒë√∫ng 100% th√¨ khen).</div>
    3. <div style="margin-bottom:10px;"><b><span style="color:#059669;">3. C√¢u chu·∫©n x√°c:</span></b> (Vi·∫øt l·∫°i m·ªôt phi√™n b·∫£n ho√†n h·∫£o nh·∫•t c·ªßa c√¢u ƒë√≥ k√®m d·ªãch nghƒ©a ti·∫øng Vi·ªát).</div>
    4. <div style="margin-top:15px; padding:15px; background:#f1f5f9; border-radius:8px;"><b>üí° G·ª£i √Ω h·ªçc th√™m:</b> (Cho 1 c√¢u v√≠ d·ª• kh√°c c·ª±c hay s·ª≠ d·ª•ng t·ª´ "${currentAIWord.kr}" ƒë·ªÉ h·ªçc vi√™n tham kh·∫£o).</div>
    QUAN TR·ªåNG: To√†n b·ªô l·ªùi gi·∫£i th√≠ch b·∫Øt bu·ªôc 100% b·∫±ng Ti·∫øng Vi·ªát.`; 
    
    try { 
        let reply = await callVercelBackend(p);
        r.innerHTML = reply.replace(/```html/g, "").replace(/```/g, ""); 
        r.style.display = "block"; gain(20); 
    } catch (e) { r.innerHTML = `<div style="color:var(--danger); font-weight: 600;">L·ªói: ${e.message}. H√£y ch·∫Øc ch·∫Øn b·∫°n ƒë√£ Deploy code l√™n Vercel th√†nh c√¥ng.</div>`; r.style.display = "block"; } 
    finally { b.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i> AI Ch·∫•m Chi Ti·∫øt`; b.disabled = false; } 
}

function resetAutoTranslation() { document.getElementById('autoTransVi').value = ''; document.getElementById('autoTransKr').value = ''; document.getElementById('autoTransResult').style.display = 'none'; }
async function checkTranslationBasic() { let v = document.getElementById('autoTransVi').value.trim(); let k = document.getElementById('autoTransKr').value.trim(); if(!v || !k) return showToast("Nh·∫≠p ƒë·ªß 2 √¥!", "error"); let b = document.getElementById('basicTransBtn'); let r = document.getElementById('autoTransResult'); b.innerHTML = `<span class="loader" style="border-top-color:var(--primary);"></span>...`; b.disabled = true; try { const r1 = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=vi&tl=ko&dt=t&q=${encodeURIComponent(v)}`); const d1 = await r1.json(); let c = d1[0].map(x => x[0]).join(''); const r2 = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=vi&dt=t&q=${encodeURIComponent(k)}`); const d2 = await r2.json(); let u = d2[0].map(x => x[0]).join(''); r.innerHTML = `<p style="color:var(--text-muted); font-weight:600; font-size:15px; margin-bottom:5px;">Google d·ªãch t·ª´ Ti·∫øng Vi·ªát sang H√†n:</p><p style="font-size:22px; font-weight:700; color:var(--text); margin-top:0;">${c}</p><div style="background: white; padding: 15px; border-radius: 10px; margin-top:15px; border: 1px solid var(--border);"><p style="color:var(--text-muted); font-size:14px; font-weight:600; margin-top:0;">V√† ƒë√¢y l√† nghƒ©a c·ªßa c√¢u ti·∫øng H√†n b·∫°n v·ª´a vi·∫øt:</p><p style="font-style:italic; font-size: 18px; margin-bottom:0; color: var(--text); font-weight:500;">"${u}"</p></div>`; r.style.display = "block"; gain(10); } catch (e) { showToast("L·ªói m·∫°ng!", "error"); } finally { b.innerHTML = `<i class="fa-solid fa-bolt"></i> ƒê·ªëi Chi·∫øu Nhanh`; b.disabled = false; } }

async function checkTranslationAI() { 
    let v = document.getElementById('autoTransVi').value.trim(); let k = document.getElementById('autoTransKr').value.trim(); 
    if(!v || !k) return showToast("Nh·∫≠p ƒë·ªß 2 √¥!", "error"); 
    let b = document.getElementById('aiTransBtn'); let r = document.getElementById('autoTransResult'); 
    b.innerHTML = `<span class="loader"></span>...`; b.disabled = true; 
    
    let p = `ƒê√≥ng vai chuy√™n gia bi√™n d·ªãch ti·∫øng H√†n. C√¢u g·ªëc h·ªçc vi√™n mu·ªën n√≥i: "${v}". H·ªçc vi√™n t·ª± d·ªãch l√†: "${k}".
    TR·∫¢ L·ªúI NG·∫ÆN G·ªåN, ƒêI TH·∫≤NG V√ÄO CHUY√äN M√îN B·∫∞NG HTML (ch·ªâ d√πng th·∫ª div, b, span). KH√îNG d√πng markdown. KH√îNG C√ì C√ÇU CH√ÄO H·ªéI (v√≠ d·ª•: c·∫•m n√≥i "Ch√†o b·∫°n", c·∫•m n√≥i "Sau ƒë√¢y l√† nh·∫≠n x√©t...").
    Ph·∫£i c√≥ ƒë·ªß 3 m·ª•c sau:
    1. <div style="margin-bottom:12px;"><b><span style="color:#2563eb;">1. ƒê√°nh gi√° s√°t nghƒ©a:</span></b> (B·∫£n d·ªãch c·ªßa h·ªçc vi√™n c√≥ truy·ªÅn t·∫£i ƒë√∫ng 100% √Ω c·ªßa c√¢u ti·∫øng Vi·ªát kh√¥ng? C√≥ d√πng t·ª´ l√≥ng hay sai ng·ªØ c·∫£nh kh√¥ng?)</div>
    2. <div style="margin-bottom:12px;"><b><span style="color:#dc2626;">2. B·∫Øt l·ªói Ng·ªØ ph√°p & Kho·∫£ng c√°ch (ÎùÑÏñ¥Ïì∞Í∏∞):</span></b> (Ch·ªâ ra l·ªói sai c·ª±c k·ª≥ chi ti·∫øt, gi·∫£i th√≠ch t·∫°i sao sai. N·∫øu ƒë√∫ng th√¨ khen).</div>
    3. <div style="margin-top:20px; padding:20px; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:12px;"><b><span style="color:#16a34a; font-size:18px;">üí° C√¢u d·ªãch ho√†n h·∫£o nh·∫•t (Ng∆∞·ªùi H√†n hay d√πng):</span></b><br><span style="font-size:24px; font-weight:bold; color:#1e293b;">(Vi·∫øt c√¢u ti·∫øng H√†n c·ª±c chu·∫©n v√†o ƒë√¢y)</span></div>
    QUAN TR·ªåNG: L·ªùi gi·∫£i th√≠ch ph·∫£i l√† Ti·∫øng Vi·ªát. ƒêi th·∫≥ng v√†o m·ª•c 1 lu√¥n.`; 
    
    try { 
        let reply = await callVercelBackend(p);
        r.innerHTML = reply.replace(/```html/g, "").replace(/```/g, ""); 
        r.style.display = "block"; gain(20); 
    } catch (e) { r.innerHTML = `<div style="color:var(--danger); font-weight: bold;">L·ªói k·∫øt n·ªëi m√°y ch·ªß: ${e.message}</div>`; r.style.display = "block"; } 
    finally { b.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i> AI Ph√¢n T√≠ch`; b.disabled = false; } 
}

/* LO·∫†I B·ªé HACK EXP KHI L∆Ø·ªöT TH·∫∫ T·ª™ V·ª∞NG */
function showFlash() { let v = vocab[index]; document.getElementById('flashCounter').innerText = `${index + 1}/${vocab.length}`; document.getElementById('flashWord').innerText = v.kr; document.getElementById('flashPr').innerText = v.pr ? `[${v.pr}]` : ""; document.getElementById('flashMean').innerText = v.vi; }
function speak() { speechSynthesis.cancel(); let u = new SpeechSynthesisUtterance(vocab[index].kr); u.lang = "ko-KR"; speechSynthesis.speak(u); }
function next() { index = (index + 1) % vocab.length; showFlash(); } /* ƒê√£ x√≥a l·ªánh gain(2) ·ªü ƒë√¢y */
function prev() { index = (index - 1 + vocab.length) % vocab.length; showFlash(); }

function startQuiz(type = 'quiz_kr_vi') { 
    currentQuizType = type;
    if(vocab.length < 4) { back(); return showToast("C·∫ßn √≠t nh·∫•t 4 t·ª´ ƒë·ªÉ ch∆°i!", "error"); } 
    
    clearInterval(quizTimerInterval);
    quizStartTime = Date.now();
    document.getElementById('quizTimer').innerText = '0';
    quizTimerInterval = setInterval(() => { document.getElementById('quizTimer').innerText = Math.floor((Date.now() - quizStartTime) / 1000); }, 1000);

    let q = vocab[Math.floor(Math.random() * vocab.length)], opts = [q]; 
    while(opts.length < 4) { let r = vocab[Math.floor(Math.random() * vocab.length)]; if(!opts.includes(r)) opts.push(r); } 
    opts.sort(() => Math.random() - 0.5); 
    let html = `<div class="quiz-title">${type === 'quiz_kr_vi' ? `${q.kr} ${q.pr ? `<span class="pr-text">[${q.pr}]</span>` : ''}` : q.vi}</div><div class="quiz-grid">`; 
    opts.forEach(o => {
        let optText = type === 'quiz_kr_vi' ? o.vi : `${o.kr} ${o.pr ? `<span class="pr-text">[${o.pr}]</span>` : ''}`;
        html += `<div class='quiz-option' onclick='checkQuiz(this,"${btoa(encodeURIComponent(type === 'quiz_kr_vi' ? o.vi : o.kr))}","${btoa(encodeURIComponent(type === 'quiz_kr_vi' ? q.vi : q.kr))}")'>${optText}</div>`;
    }); 
    document.getElementById('quizBox').innerHTML = html + `</div>`; 
}

function checkQuiz(e, s, c) { 
    clearInterval(quizTimerInterval);
    let timeTaken = Math.floor((Date.now() - quizStartTime) / 1000);

    if(s === c) { 
        e.style.background = "#dcfce7"; e.style.borderColor = "#22c55e"; 
        gain(10); 
        showToast(`Tuy·ªát! Ho√†n th√†nh trong ${timeTaken}s`, "success");
        setTimeout(() => startQuiz(currentQuizType), 1000); 
    } 
    else { 
        e.style.background = "#fee2e2"; e.style.borderColor = "#ef4444"; 
        setTimeout(() => startQuiz(currentQuizType), 1500); 
    } 
}

let mC = 0; 
function startMatchGame() { if(vocab.length < 3) { back(); return showToast("C·∫ßn √≠t nh·∫•t 3 t·ª´ ƒë·ªÉ ch∆°i!", "error"); } mC = 0; let m = document.getElementById('matchBox'); m.innerHTML = ""; let p = [...vocab].sort(() => Math.random() - 0.5).slice(0, 3); let a = [...p.map(v => ({t: v.kr, id: v.kr})), ...p.map(v => ({t: v.vi, id: v.kr}))].sort(() => Math.random() - 0.5); a.forEach(x => { let d = document.createElement("div"); d.className = "match-box"; d.innerText = x.t; d.onclick = () => pM(d, x.id); m.appendChild(d); }); }
function pM(d, id) { if(d.classList.contains('hidden') || d.classList.contains('selected')) return; if(!selected) { selected = {d, id}; d.classList.add("selected"); } else { if(selected.id === id) { d.style.background = "#dcfce7"; d.style.borderColor = "#22c55e"; selected.d.style.background = "#dcfce7"; selected.d.style.borderColor = "#22c55e"; gain(15); setTimeout(() => { d.classList.add("hidden"); selected.d.classList.add("hidden"); selected = null; mC += 2; if(mC >= 6) setTimeout(startMatchGame, 500); }, 500); } else { d.style.background = "#fee2e2"; d.style.borderColor = "#ef4444"; selected.d.style.background = "#fee2e2"; selected.d.style.borderColor = "#ef4444"; setTimeout(() => { d.style.background = ""; d.style.borderColor = ""; selected.d.style.background = ""; selected.d.style.borderColor = ""; selected.d.classList.remove("selected"); selected = null; }, 600); } } }
</script>
</body>
</html>
